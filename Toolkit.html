<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NWA AI Bubble Analysis Toolkit | North West Atlas B Corp</title>
    <meta name="description" content="Institutional-grade AI sector bubble analysis. Real-time Bubble Index, Contagion Map, Company Intelligence Cards, Portfolio Stress Test. 68 companies tracked.">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="NWA AI Bubble Analysis Toolkit">
    <meta property="og:description" content="Institutional terminal for AI sector systemic risk. Bubble Index™, Contagion Map, 68 Company Cards, Portfolio Stress Test.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://northwestatlas.com/Toolkit.html">
    <meta property="og:image" content="https://northwestatlas.com/og-toolkit.png">
    <link rel="canonical" href="https://northwestatlas.com/Toolkit.html">
    <link rel="icon" href="favicon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Playfair+Display:wght@200;300;400&family=Inter:wght@200;300;400;500;600&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">

    <!-- External Libraries -->
    <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script defer src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        /* ═══════════════════════════════════════════
           NWA TOOLKIT 5.0 — PRODUCTION READY
           ═══════════════════════════════════════════ */
        :root {
            --gold: #C5A059;
            --gold-light: #E8D5B5;
            --gold-dark: #8B6F4C;
            --gold-accent: #D4AF61;
            --gold-rgb: 197, 160, 89;

            --red: #E54D4D;
            --red-soft: #FF6B6B;
            --red-bg: rgba(229, 77, 77, 0.08);
            --red-border: rgba(229, 77, 77, 0.2);

            --orange: #F0A030;
            --orange-bg: rgba(240, 160, 48, 0.08);
            --orange-border: rgba(240, 160, 48, 0.2);

            --green: #34D399;
            --green-bg: rgba(52, 211, 153, 0.08);
            --green-border: rgba(52, 211, 153, 0.2);

            --blue: #60A5FA;
            --blue-bg: rgba(96, 165, 250, 0.08);

            --navy: #0A0A0F;
            --navy-deep: #060609;
            --navy-surface: #0E0E15;
            --surface-card: #111119;
            --surface-elevated: #16161F;
            --surface-hover: #1A1A25;
            --border-subtle: rgba(197, 160, 89, 0.06);
            --border-medium: rgba(197, 160, 89, 0.12);

            --text-primary: #F2F0ED;
            --text-secondary: #9FA6B4;
            --text-muted: #6B7280;
            --text-dim: #4B5060;

            --font-serif: 'EB Garamond', Georgia, serif;
            --font-display: 'Playfair Display', Georgia, serif;
            --font-sans: 'Inter', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

            --ease: cubic-bezier(0.25, 0.1, 0.25, 1);
            --ease-out: cubic-bezier(0.0, 0, 0.2, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);

            --radius-xs: 4px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;

            --shadow-sm: 0 2px 8px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 20px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
            --shadow-glow: 0 0 60px rgba(197,160,89,0.04);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            scroll-behavior: smooth;
            scroll-padding-top: 80px;
            background: var(--navy-deep);
        }

        body {
            font-family: var(--font-sans);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            background: var(--navy-deep);
            min-height: 100vh;
            font-weight: 300;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        ::selection {
            background: rgba(197,160,89,0.2);
            color: var(--text-primary);
        }

        .gold-text { color: var(--gold); }

        /* ═══════ AMBIENT BACKGROUND ═══════ */
        .ambient-bg {
            position: fixed;
            inset: 0;
            z-index: -2;
            overflow: hidden;
        }

        .ambient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            animation: orbDrift 25s ease-in-out infinite;
        }

        .orb-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(197,160,89,0.04) 0%, transparent 70%);
            top: -5%; left: -5%;
        }

        .orb-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(197,160,89,0.025) 0%, transparent 70%);
            bottom: -10%; right: -8%;
            animation-delay: -10s;
        }

        @keyframes orbDrift {
            0%, 100% { opacity: 0.5; transform: translate(0, 0); }
            33% { opacity: 0.7; transform: translate(20px, -15px); }
            66% { opacity: 0.4; transform: translate(-15px, 20px); }
        }

        .noise-overlay {
            position: fixed;
            inset: 0;
            z-index: -1;
            opacity: 0.012;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            background-size: 256px;
        }

        /* ═══════ LAYOUT ═══════ */
        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .container-narrow {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* ═══════ HEADER ═══════ */
        .toolkit-header {
            position: fixed;
            top: 0; left: 0; width: 100%;
            z-index: 100;
            padding: 0.8rem 0;
            background: rgba(6,6,9,0.9);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-bottom: 1px solid var(--border-subtle);
            transition: all 0.5s var(--ease);
        }

        .header-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .header-logo {
            height: 32px;
            width: auto;
            opacity: 0.8;
            transition: opacity 0.4s;
        }

        .header-logo:hover { opacity: 1; }

        .header-divider {
            width: 1px;
            height: 20px;
            background: var(--border-medium);
        }

        .header-title {
            font-family: var(--font-sans);
            font-size: 0.65rem;
            font-weight: 400;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--green);
            font-weight: 400;
        }

        .live-dot {
            width: 6px; height: 6px;
            background: var(--green);
            border-radius: 50%;
            animation: livePulse 2s ease-in-out infinite;
        }

        @keyframes livePulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(52,211,153,0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 4px rgba(52,211,153,0); }
        }

        .header-back {
            font-size: 0.6rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.4s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .header-back:hover { color: var(--gold); }

        .header-back svg {
            width: 14px; height: 14px;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.5;
        }

        /* ═══════ HERO SECTION ═══════ */
        .toolkit-hero {
            padding: 8rem 0 3rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .hero-top-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 3rem;
            margin-bottom: 3rem;
        }

        .hero-info {
            flex: 1;
        }

        .hero-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.3rem 1rem;
            font-size: 0.5rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: var(--red-bg);
            border: 1px solid var(--red-border);
            color: var(--red-soft);
            border-radius: var(--radius-full);
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .hero-badge-dot {
            width: 5px; height: 5px;
            background: var(--red);
            border-radius: 50%;
            animation: livePulse 2s ease-in-out infinite;
        }

        .toolkit-hero h1 {
            font-family: var(--font-display);
            font-size: clamp(2.2rem, 4vw, 3.2rem);
            font-weight: 200;
            color: var(--text-primary);
            line-height: 1.1;
            letter-spacing: -0.02em;
            margin-bottom: 1rem;
        }

        .hero-subtitle {
            font-family: var(--font-serif);
            font-size: 1.1rem;
            font-style: italic;
            color: var(--text-muted);
            max-width: 480px;
            line-height: 1.7;
        }

        .hero-meta {
            display: flex;
            gap: 2rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-subtle);
        }

        .hero-meta-item {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .hero-meta-value {
            font-family: var(--font-display);
            font-size: 1.3rem;
            font-weight: 200;
            color: var(--text-primary);
        }

        .hero-meta-label {
            font-size: 0.5rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 300;
        }

        /* ═══════ BUBBLE INDEX CARD ═══════ */
        .bubble-index-card {
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            position: relative;
            overflow: hidden;
            min-width: 340px;
            max-width: 400px;
        }

        .bubble-index-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            opacity: 0.3;
        }

        .bic-label {
            font-size: 0.5rem;
            letter-spacing: 0.35em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 1.5rem;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .bic-label::before {
            content: '';
            width: 16px; height: 1px;
            background: var(--gold);
            opacity: 0.4;
        }

        .bic-score-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .bic-score {
            font-family: var(--font-display);
            font-size: 4.5rem;
            font-weight: 200;
            line-height: 1;
            letter-spacing: -0.03em;
        }

        .bic-score-meta {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .bic-signal {
            font-size: 0.6rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 0.2rem 0.6rem;
            border-radius: var(--radius-full);
            display: inline-block;
        }

        .signal-elevated {
            background: var(--orange-bg);
            border: 1px solid var(--orange-border);
            color: var(--orange);
        }

        .signal-high {
            background: var(--red-bg);
            border: 1px solid var(--red-border);
            color: var(--red-soft);
        }

        .signal-moderate {
            background: var(--orange-bg);
            border: 1px solid var(--orange-border);
            color: var(--orange);
        }

        .signal-low {
            background: var(--green-bg);
            border: 1px solid var(--green-border);
            color: var(--green);
        }

        .bic-trend {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-weight: 300;
        }

        .bic-trend .up { color: var(--red-soft); }
        .bic-trend .down { color: var(--green); }

        .bic-gauge {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.04);
            border-radius: var(--radius-full);
            margin-bottom: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .bic-gauge-fill {
            height: 100%;
            border-radius: var(--radius-full);
            transition: width 2s var(--ease), background 1s var(--ease);
            position: relative;
        }

        .bic-gauge-fill::after {
            content: '';
            position: absolute;
            right: 0; top: -2px;
            width: 10px; height: 10px;
            background: inherit;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }

        .bic-gauge-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.45rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 1.5rem;
        }

        .bic-components {
            border-top: 1px solid var(--border-subtle);
            padding-top: 1.2rem;
        }

        .bic-comp-title {
            font-size: 0.5rem;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 0.8rem;
        }

        .bic-comp-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            font-size: 0.7rem;
        }

        .bic-comp-name {
            color: var(--text-muted);
            font-weight: 300;
        }

        .bic-comp-value {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            font-weight: 400;
        }

        .bic-comp-bar {
            flex: 1;
            height: 3px;
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-full);
            margin: 0 0.8rem;
            overflow: hidden;
        }

        .bic-comp-bar-fill {
            height: 100%;
            border-radius: var(--radius-full);
            transition: width 1.5s var(--ease);
        }

        /* ═══════ NAVIGATION TABS ═══════ */
        .toolkit-nav {
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-subtle);
            position: sticky;
            top: 55px;
            z-index: 90;
            background: rgba(6,6,9,0.95);
            backdrop-filter: blur(30px);
        }

        .nav-tabs {
            display: flex;
            gap: 0;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar { display: none; }

        .nav-tab {
            font-size: 0.6rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dim);
            text-decoration: none;
            padding: 0.7rem 1.5rem;
            border-bottom: 2px solid transparent;
            transition: all 0.4s var(--ease);
            white-space: nowrap;
            font-weight: 400;
            cursor: pointer;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: var(--font-sans);
        }

        .nav-tab:hover {
            color: var(--text-secondary);
        }

        .nav-tab.active {
            color: var(--gold);
            border-bottom-color: var(--gold);
        }

        /* ═══════ SECTION CONTAINERS ═══════ */
        .toolkit-section {
            padding: 3rem 0;
            display: none;
        }

        .toolkit-section.active {
            display: block;
        }

        .section-header {
            margin-bottom: 2.5rem;
        }

        .section-label {
            font-size: 0.55rem;
            letter-spacing: 0.4em;
            text-transform: uppercase;
            color: var(--gold);
            margin-bottom: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            opacity: 0.7;
            font-weight: 400;
        }

        .section-label::before {
            content: '';
            width: 20px; height: 1px;
            background: var(--gold);
            opacity: 0.4;
        }

        .section-title {
            font-family: var(--font-display);
            font-size: clamp(1.8rem, 3vw, 2.4rem);
            font-weight: 200;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .section-desc {
            font-family: var(--font-serif);
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-top: 0.8rem;
            max-width: 550px;
            line-height: 1.7;
            font-style: italic;
        }

        /* ═══════ EARLY WARNING DASHBOARD ═══════ */
        .ew-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .ew-card {
            background: var(--surface-card);
            padding: 1.5rem;
            transition: background 0.5s var(--ease);
            cursor: default;
        }

        .ew-card:hover { background: var(--surface-hover); }

        .ew-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.8rem;
        }

        .ew-card-name {
            font-size: 0.75rem;
            color: var(--text-primary);
            font-weight: 400;
        }

        .ew-status {
            font-size: 0.5rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-full);
            font-weight: 500;
        }

        .ew-status-high {
            background: var(--red-bg);
            border: 1px solid var(--red-border);
            color: var(--red-soft);
        }

        .ew-status-watch {
            background: var(--orange-bg);
            border: 1px solid var(--orange-border);
            color: var(--orange);
        }

        .ew-status-ok {
            background: var(--green-bg);
            border: 1px solid var(--green-border);
            color: var(--green);
        }

        .ew-card-detail {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.6;
            font-weight: 300;
        }

        .ew-card-trend {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-top: 0.6rem;
            font-size: 0.6rem;
            font-weight: 400;
        }

        .trend-up { color: var(--red-soft); }
        .trend-down { color: var(--green); }
        .trend-flat { color: var(--text-dim); }

        .ew-alerts {
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .ew-alerts-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.55rem;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 400;
        }

        .ew-alert-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.02);
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            transition: background 0.3s;
        }

        .ew-alert-item:hover { background: rgba(255,255,255,0.01); }
        .ew-alert-item:last-child { border-bottom: none; }

        .alert-severity {
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-top: 0.3rem;
            flex-shrink: 0;
        }

        .severity-critical { background: var(--red); }
        .severity-warning { background: var(--orange); }
        .severity-info { background: var(--blue); }

        .alert-content { flex: 1; }

        .alert-title {
            font-size: 0.75rem;
            color: var(--text-primary);
            font-weight: 400;
            margin-bottom: 0.2rem;
        }

        .alert-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.5;
            font-weight: 300;
        }

        .alert-date {
            font-family: var(--font-mono);
            font-size: 0.55rem;
            color: var(--text-dim);
            white-space: nowrap;
            margin-top: 0.2rem;
        }

        /* ═══════ PROTOCOL TRIGGERS ═══════ */
        .protocol-container {
            margin-bottom: 2rem;
        }

        .protocol-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            margin-bottom: 2px;
            transition: all 0.4s var(--ease);
        }

        .protocol-item.triggered {
            border-color: var(--red-border);
            background: var(--red-bg);
        }

        .protocol-level {
            font-family: var(--font-display);
            font-size: 1rem;
            color: var(--gold);
            min-width: 40px;
            opacity: 0.6;
        }

        .protocol-desc {
            flex: 1;
            padding: 0 1.5rem;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .protocol-status {
            padding: 0.2rem 0.8rem;
            border-radius: var(--radius-full);
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-active {
            background: var(--green-bg);
            color: var(--green);
        }

        .status-triggered {
            background: var(--red-bg);
            color: var(--red-soft);
        }

        .manual-flags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        .flag-btn {
            padding: 0.5rem 1rem;
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.4s var(--ease);
        }

        .flag-btn:hover, .flag-btn.active {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(var(--gold-rgb), 0.04);
        }

        /* ═══════ COMPANY CARDS ═══════ */
        .company-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.75rem;
            font-weight: 300;
            outline: none;
            transition: border-color 0.4s;
            -webkit-user-select: text;
            user-select: text;
        }

        .search-input:focus {
            border-color: var(--gold);
        }

        .search-input::placeholder {
            color: var(--text-dim);
        }

        .search-icon {
            position: absolute;
            left: 0.8rem;
            top: 50%;
            transform: translateY(-50%);
            width: 14px; height: 14px;
            stroke: var(--text-dim);
            fill: none;
            stroke-width: 1.5;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.4s var(--ease);
            font-family: var(--font-sans);
            font-weight: 400;
        }

        .filter-btn:hover, .filter-btn.active {
            border-color: var(--gold);
            color: var(--gold);
            background: rgba(var(--gold-rgb), 0.04);
        }

        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1px;
            background: var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .company-card {
            background: var(--surface-card);
            padding: 1.5rem;
            transition: all 0.5s var(--ease);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .company-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--gold), transparent);
            opacity: 0;
            transition: opacity 0.5s;
        }

        .company-card:hover { background: var(--surface-hover); }
        .company-card:hover::before { opacity: 0.3; }

        .cc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .cc-ticker {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .cc-name {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 300;
            margin-top: 0.15rem;
        }

        .cc-tier {
            font-size: 0.5rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            padding: 0.15rem 0.5rem;
            border-radius: var(--radius-full);
            font-weight: 400;
            background: rgba(var(--gold-rgb), 0.06);
            border: 1px solid rgba(var(--gold-rgb), 0.12);
            color: var(--gold);
        }

        .cc-score-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .cc-bubble-score {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 200;
            line-height: 1;
        }

        .cc-score-gauge {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.03);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .cc-score-gauge-fill {
            height: 100%;
            border-radius: var(--radius-full);
        }

        .cc-key-question {
            font-family: var(--font-serif);
            font-size: 0.8rem;
            font-style: italic;
            color: var(--text-secondary);
            padding: 0.8rem;
            background: rgba(var(--gold-rgb), 0.03);
            border-left: 2px solid rgba(var(--gold-rgb), 0.15);
            border-radius: 0 var(--radius-xs) var(--radius-xs) 0;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .cc-flags {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .cc-flag {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 300;
        }

        .cc-flag-icon {
            font-size: 0.6rem;
        }

        .cc-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-subtle);
        }

        .cc-pe {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .cc-thesis {
            font-size: 0.55rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            padding: 0.2rem 0.6rem;
            border-radius: var(--radius-full);
            font-weight: 500;
        }

        .thesis-hold {
            background: var(--orange-bg);
            border: 1px solid var(--orange-border);
            color: var(--orange);
        }

        .thesis-reduce {
            background: var(--red-bg);
            border: 1px solid var(--red-border);
            color: var(--red-soft);
        }

        .thesis-accumulate {
            background: var(--green-bg);
            border: 1px solid var(--green-border);
            color: var(--green);
        }

        /* ═══════ DCF MODEL ═══════ */
        .dcf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .dcf-card {
            background: var(--surface-card);
            padding: 2rem;
        }

        .slider-container {
            margin-bottom: 1.5rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .slider-value {
            color: var(--gold);
            font-family: var(--font-mono);
        }

        input[type=range] {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: var(--radius-full);
            -webkit-appearance: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px; height: 16px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(197,160,89,0.3);
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .metric-row:last-child { border-bottom: none; }

        .metric-label {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .metric-value {
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .value-gold { color: var(--gold); }
        .value-green { color: var(--green); }
        .value-red { color: var(--red-soft); }

        /* ═══════ NEWS FEED ═══════ */
        .news-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .news-stats {
            display: flex;
            gap: 1rem;
        }

        .news-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.65rem;
        }

        .news-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
        }

        .dot-positive { background: var(--green); }
        .dot-negative { background: var(--red-soft); }
        .dot-neutral { background: var(--orange); }

        .refresh-btn {
            padding: 0.4rem 1rem;
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.4s;
        }

        .refresh-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .news-container {
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .news-item {
            padding: 1.2rem 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: background 0.3s;
        }

        .news-item:hover {
            background: var(--surface-hover);
        }

        .news-item:last-child { border-bottom: none; }

        .news-title {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
            font-weight: 400;
        }

        .news-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.6rem;
            color: var(--text-dim);
            margin-bottom: 0.3rem;
        }

        .news-sentiment {
            padding: 0.1rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.5rem;
            text-transform: uppercase;
        }

        .sentiment-positive {
            background: var(--green-bg);
            color: var(--green);
        }

        .sentiment-negative {
            background: var(--red-bg);
            color: var(--red-soft);
        }

        .sentiment-neutral {
            background: var(--orange-bg);
            color: var(--orange);
        }

        .news-summary {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* ═══════ CONTAGION MAP ═══════ */
        .contagion-controls {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
        }

        .contagion-slider-group {
            flex: 1;
        }

        .contagion-slider-label {
            font-size: 0.55rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
            display: block;
        }

        .contagion-slider-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .contagion-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: var(--radius-full);
            outline: none;
        }

        .contagion-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px; height: 16px;
            background: var(--gold);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(197,160,89,0.3);
        }

        .contagion-value {
            font-family: var(--font-mono);
            font-size: 1.4rem;
            font-weight: 400;
            min-width: 60px;
            text-align: right;
        }

        .contagion-tiers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .contagion-tier {
            background: var(--surface-card);
            padding: 1.5rem;
        }

        .ct-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .ct-title {
            font-size: 0.6rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dim);
            font-weight: 400;
        }

        .ct-impact {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            font-weight: 400;
        }

        .ct-company {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }

        .ct-company:last-child { border-bottom: none; }

        .ct-ticker {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .ct-change {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            font-weight: 400;
        }

        .ct-bar {
            flex: 1;
            height: 3px;
            background: rgba(255,255,255,0.03);
            margin: 0 0.8rem;
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .ct-bar-fill {
            height: 100%;
            background: var(--red);
            border-radius: var(--radius-full);
            transition: width 0.8s var(--ease);
        }

        /* ═══════ STRESS TEST ═══════ */
        .stress-input-area {
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .stress-input-title {
            font-size: 0.55rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 1.5rem;
        }

        .portfolio-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.8rem;
        }

        .portfolio-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .portfolio-input-group label {
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .portfolio-input {
            padding: 0.5rem 0.7rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            outline: none;
            transition: border-color 0.4s;
            -webkit-user-select: text;
            user-select: text;
        }

        .portfolio-input:focus {
            border-color: var(--gold);
        }

        .stress-btn {
            margin-top: 1.5rem;
            padding: 0.7rem 2rem;
            background: rgba(var(--gold-rgb), 0.08);
            border: 1px solid rgba(var(--gold-rgb), 0.2);
            border-radius: var(--radius-md);
            color: var(--gold);
            font-family: var(--font-sans);
            font-size: 0.6rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.4s var(--ease);
            font-weight: 400;
        }

        .stress-btn:hover {
            background: rgba(var(--gold-rgb), 0.12);
            border-color: var(--gold);
            transform: translateY(-1px);
        }

        .stress-results {
            display: none;
        }

        .stress-results.visible {
            display: block;
        }

        .stress-exposure {
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .exposure-value {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 200;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
        }

        .exposure-label {
            font-size: 0.55rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 1rem;
        }

        .stress-scenarios {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .stress-scenario {
            background: var(--surface-card);
            padding: 1.5rem;
            text-align: center;
        }

        .scenario-name {
            font-size: 0.55rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .scenario-shock {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 0.8rem;
        }

        .scenario-result {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 200;
        }

        /* ═══════ HISTORICAL OVERLAY ═══════ */
        .history-chart-container {
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-md);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .history-chart {
            width: 100%;
            height: 350px;
            position: relative;
            overflow: hidden;
        }

        .history-chart canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .history-position {
            background: rgba(var(--gold-rgb), 0.04);
            border: 1px solid rgba(var(--gold-rgb), 0.1);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2rem;
            text-align: center;
        }

        .hp-item {}

        .hp-value {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 200;
            color: var(--text-primary);
        }

        .hp-label {
            font-size: 0.5rem;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-top: 0.3rem;
        }

        /* ═══════ METHODOLOGY ═══════ */
        .methodology-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1px;
            background: var(--border-subtle);
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .method-card {
            background: var(--surface-card);
            padding: 1.5rem;
        }

        .method-number {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--gold);
            opacity: 0.4;
            margin-bottom: 0.5rem;
        }

        .method-title {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 400;
            margin-bottom: 0.5rem;
        }

        .method-desc {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.7;
            font-weight: 300;
        }

        .method-weight {
            font-family: var(--font-mono);
            font-size: 0.6rem;
            color: var(--gold);
            opacity: 0.6;
            margin-top: 0.5rem;
        }

        /* ═══════ SETTINGS MODAL ═══════ */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(6,6,9,0.95);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s var(--ease);
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: var(--surface-elevated);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-lg);
            padding: 2.5rem;
            max-width: 420px;
            width: 90%;
        }

        .modal-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-header h3 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 200;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.6rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .form-group input {
            width: 100%;
            padding: 0.6rem 1rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.8rem;
            outline: none;
            transition: border-color 0.4s;
        }

        .form-group input:focus {
            border-color: var(--gold);
        }

        .form-group small {
            display: block;
            margin-top: 0.3rem;
            font-size: 0.6rem;
            color: var(--text-dim);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 0.6rem 1.5rem;
            font-size: 0.6rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: rgba(var(--gold-rgb), 0.04);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.4s;
        }

        .modal-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .modal-btn.primary {
            background: rgba(var(--gold-rgb), 0.08);
            border-color: rgba(var(--gold-rgb), 0.2);
            color: var(--gold);
        }

        .modal-btn.primary:hover {
            background: rgba(var(--gold-rgb), 0.12);
            border-color: var(--gold);
        }

        /* ═══════ DETAIL PANEL ═══════ */
        .detail-panel {
            position: fixed;
            right: -380px;
            top: 0;
            width: 340px;
            height: 100vh;
            background: var(--surface-elevated);
            backdrop-filter: blur(40px);
            border-left: 1px solid var(--border-medium);
            padding: 2.5rem 1.5rem;
            transition: right 0.6s var(--ease);
            z-index: 1001;
            overflow-y: auto;
        }

        .detail-panel.active { right: 0; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .panel-header h3 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            font-weight: 200;
            color: var(--text-primary);
        }

        .close-btn {
            cursor: pointer;
            padding: 0.3rem;
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            background: none;
            color: var(--text-muted);
            transition: all 0.4s;
        }

        .close-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .close-btn svg {
            width: 16px; height: 16px;
            stroke: currentColor;
        }

        /* ═══════ TOAST NOTIFICATION ═══════ */
        .toast {
            position: fixed;
            bottom: 20px; right: 20px;
            background: var(--surface-elevated);
            backdrop-filter: blur(20px);
            border-left: 2px solid var(--gold);
            padding: 0.8rem 1.2rem;
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            z-index: 10002;
            animation: slideIn 0.3s var(--ease);
            max-width: 320px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .toast.error { border-left-color: var(--red); }
        .toast.success { border-left-color: var(--green); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ═══════ LOADING OVERLAY ═══════ */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(6,6,9,0.96);
            backdrop-filter: blur(20px);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s var(--ease);
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loading-content {
            text-align: center;
        }

        .loader {
            width: 40px; height: 40px;
            border: 2px solid rgba(var(--gold-rgb), 0.1);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 0.7rem;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        /* ═══════ EXPORT BAR ═══════ */
        .export-bar {
            display: flex;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 0.4rem 1rem;
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            background: var(--surface-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.4s;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .export-btn:hover {
            border-color: var(--gold);
            color: var(--gold);
        }

        .export-btn svg {
            width: 12px; height: 12px;
            stroke: currentColor;
        }

        /* ═══════ FOOTER ═══════ */
        .toolkit-footer {
            padding: 2rem 0;
            border-top: 1px solid var(--border-subtle);
            margin-top: 3rem;
        }

        .toolkit-footer-inner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .toolkit-footer p {
            font-size: 0.55rem;
            color: var(--text-dim);
            font-weight: 300;
        }

        .toolkit-footer a {
            color: var(--gold);
            text-decoration: none;
            opacity: 0.6;
            transition: opacity 0.4s;
        }

        .toolkit-footer a:hover { opacity: 1; }

        /* ═══════ UTILITY ═══════ */
        .color-red { color: var(--red-soft); }
        .color-orange { color: var(--orange); }
        .color-green { color: var(--green); }
        .color-gold { color: var(--gold); }

        .reveal {
            opacity: 0;
            transform: translateY(12px);
            transition: all 0.8s var(--ease);
        }
        .reveal.visible { opacity: 1; transform: none; }

        .mb-lg { margin-bottom: 2rem; }

        /* ═══════ RESPONSIVE ═══════ */
        @media (max-width: 1024px) {
            .hero-top-row { flex-direction: column; }
            .bubble-index-card { max-width: 100%; }
            .dcf-grid { grid-template-columns: 1fr; }
            .contagion-tiers { grid-template-columns: 1fr; }
            .stress-scenarios { grid-template-columns: 1fr; }
            .history-position { grid-template-columns: 1fr; gap: 1rem; }
        }

        @media (max-width: 768px) {
            .container, .container-narrow { padding: 0 1rem; }
            .ew-grid { grid-template-columns: 1fr; }
            .companies-grid { grid-template-columns: 1fr; }
            .methodology-grid { grid-template-columns: 1fr; }
            .contagion-controls { flex-direction: column; }
            .hero-meta { flex-wrap: wrap; }
            .header-title { display: none; }
            .nav-tabs { gap: 0; }
            .nav-tab { padding: 0.7rem 0.8rem; font-size: 0.5rem; }
            .portfolio-inputs { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .company-controls { flex-direction: column; }
            .search-box { width: 100%; }
            .filter-btn { width: 100%; }
        }

        @media (prefers-reduced-motion: reduce) {
            .reveal { opacity: 1; transform: none; transition: none; }
            .ambient-orb { animation: none; opacity: 0.5; }
            .live-dot { animation: none; }
        }

        @media print {
            .ambient-bg, .noise-overlay, .toolkit-header, .toolkit-nav,
            .modal, .detail-panel, .loading-overlay, .toast, .export-bar {
                display: none;
            }
            body { background: #fff; color: #000; }
            .bubble-index-card, .ew-card, .company-card, .dcf-card,
            .contagion-tier, .stress-exposure, .stress-scenario,
            .history-chart-container, .history-position, .method-card {
                background: #fff;
                color: #000;
                border-color: #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Ambient Background -->
    <div class="ambient-bg" aria-hidden="true">
        <div class="ambient-orb orb-1"></div>
        <div class="ambient-orb orb-2"></div>
    </div>
    <div class="noise-overlay" aria-hidden="true"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loader"></div>
            <div class="loading-text" id="loadingText">Initializing...</div>
        </div>
    </div>

    <!-- Toast Container (for JS) -->
    <div id="toastContainer"></div>

    <!-- Header -->
    <header class="toolkit-header">
        <div class="container">
            <div class="header-inner">
                <div class="header-left">
                    <a href="index.html">
                        <img src="logo-nwa-centered.png" alt="NWA" class="header-logo" width="120" height="32">
                    </a>
                    <div class="header-divider" aria-hidden="true"></div>
                    <span class="header-title">AI Bubble Analysis Toolkit</span>
                </div>
                <div class="header-right">
                    <div class="live-indicator">
                        <span class="live-dot" aria-hidden="true"></span>
                        <span>Live Data</span>
                    </div>
                    <a href="index.html" class="header-back">
                        <svg viewBox="0 0 24 24"><path d="M19 12H5m7-7l-7 7 7 7"/></svg>
                        <span>Main site</span>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- Hero -->
        <section class="toolkit-hero">
            <div class="container">
                <div class="hero-top-row">
                    <div class="hero-info">
                        <div class="hero-badge">
                            <span class="hero-badge-dot"></span>
                            <span>Systemic Risk Monitor</span>
                        </div>
                        <h1>AI Bubble Analysis<br><span class="gold-text">Toolkit</span></h1>
                        <p class="hero-subtitle">
                            Institutional-grade terminal for AI sector systemic risk verification, 
                            contagion analysis, and algorithmic asset protection protocols
                        </p>
                        <div class="hero-meta">
                            <div class="hero-meta-item">
                                <span class="hero-meta-value" id="companiesTracked">68</span>
                                <span class="hero-meta-label">Companies tracked</span>
                            </div>
                            <div class="hero-meta-item">
                                <span class="hero-meta-value">12</span>
                                <span class="hero-meta-label">Risk factors</span>
                            </div>
                            <div class="hero-meta-item">
                                <span class="hero-meta-value" id="latestUpdate">Q4 '25</span>
                                <span class="hero-meta-label">Latest update</span>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Bubble Index Card -->
                    <div class="bubble-index-card" id="bubbleIndexCard">
                        <div class="bic-label">NWA AI Bubble Index™</div>
                        
                        <div class="bic-score-container">
                            <div class="bic-score" id="bicScore">73</div>
                            <div class="bic-score-meta">
                                <span class="bic-signal" id="bicSignal">Elevated</span>
                                <span class="bic-trend" id="bicTrend">Trend: <span class="up">↑ Rising</span></span>
                            </div>
                        </div>

                        <div class="bic-gauge">
                            <div class="bic-gauge-fill" id="bicGauge" style="width: 73%; background: linear-gradient(90deg, var(--green), var(--orange), var(--red));"></div>
                        </div>
                        <div class="bic-gauge-labels">
                            <span>0 Safe</span>
                            <span>25</span>
                            <span>50</span>
                            <span>75</span>
                            <span>100 Extreme</span>
                        </div>

                        <div class="bic-components" id="bicComponents">
                            <!-- Dynamic components loaded via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <nav class="toolkit-nav" aria-label="Toolkit sections">
            <div class="container">
                <div class="nav-tabs" role="tablist">
                    <button class="nav-tab active" role="tab" data-tab="dashboard" aria-selected="true">Dashboard</button>
                    <button class="nav-tab" role="tab" data-tab="early-warning" aria-selected="false">Early Warning</button>
                    <button class="nav-tab" role="tab" data-tab="companies" aria-selected="false">Companies (68)</button>
                    <button class="nav-tab" role="tab" data-tab="contagion" aria-selected="false">Contagion Map</button>
                    <button class="nav-tab" role="tab" data-tab="dcf" aria-selected="false">DCF Model</button>
                    <button class="nav-tab" role="tab" data-tab="news" aria-selected="false">News Feed</button>
                    <button class="nav-tab" role="tab" data-tab="stress-test" aria-selected="false">Stress Test</button>
                    <button class="nav-tab" role="tab" data-tab="history" aria-selected="false">Historical</button>
                    <button class="nav-tab" role="tab" data-tab="methodology" aria-selected="false">Methodology</button>
                </div>
            </div>
        </nav>

        <!-- TAB: DASHBOARD (v1 style) -->
        <section class="toolkit-section active" id="tab-dashboard" role="tabpanel">
            <div class="container">
                <div class="section-header">
                    <span class="section-label">Executive Summary</span>
                    <h2 class="section-title">Market <span class="gold-text">Dashboard</span></h2>
                    <p class="section-desc" id="dashboardDesc">Loading real-time market data...</p>
                </div>

                <!-- Executive Summary Card -->
                <div class="bubble-index-card" style="max-width:100%; margin-bottom:2rem;" id="executiveCard">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                        <span class="bic-label">Capital Protection Status</span>
                        <div style="display:flex; gap:0.5rem;">
                            <span class="bic-signal" id="regimeBadge">PEAK</span>
                            <span class="bic-signal" id="confidenceBadge">HIGH</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:2fr 1fr; gap:2rem;">
                        <div>
                            <p id="executiveSummary" style="color:var(--text-secondary); line-height:1.7; margin-bottom:1rem;">Analyzing market conditions...</p>
                            <div style="background:rgba(0,0,0,0.25); border-left:2px solid var(--gold); padding:1rem;">
                                <h4 style="color:var(--gold); margin-bottom:0.5rem; font-size:0.85rem;">Recommended Actions</h4>
                                <p id="executiveActions">Loading...</p>
                            </div>
                        </div>
                        <div>
                            <h4 style="color:var(--gold); margin-bottom:1rem; font-size:0.85rem;">Quick Stats</h4>
                            <div id="quickStats"></div>
                        </div>
                    </div>
                </div>

                <!-- Metrics Grid -->
                <div class="ew-grid" style="margin-bottom:2rem;">
                    <div class="ew-card">
                        <div class="ew-card-header">
                            <span class="ew-card-name">Market Snapshot</span>
                        </div>
                        <div id="marketSnapshot"></div>
                    </div>
                    <div class="ew-card">
                        <div class="ew-card-header">
                            <span class="ew-card-name">AI Leaders</span>
                        </div>
                        <div id="aiLeaders"></div>
                    </div>
                    <div class="ew-card">
                        <div class="ew-card-header">
                            <span class="ew-card-name">Risk Analytics</span>
                        </div>
                        <div id="riskMetrics"></div>
                    </div>
                    <div class="ew-card">
                        <div class="ew-card-header">
                            <span class="ew-card-name">Protocol Status</span>
                        </div>
                        <div id="protocolStatus"></div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="history-chart-container">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h3 style="font-family:var(--font-display); font-weight:200;">NASDAQ-100 vs NVDA (30 Days)</h3>
                        <button class="filter-btn" id="resetZoomBtn">Reset Zoom</button>
                    </div>
                    <div class="history-chart">
                        <canvas id="dashboardChart"></canvas>
                    </div>
                </div>

                <!-- Export Bar -->
                <div class="export-bar">
                    <button class="export-btn" id="exportDashCSV">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export CSV
                    </button>
                    <button class="export-btn" id="exportDashPDF">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export PDF
                    </button>
                </div>
            </div>
        </section>

        <!-- TAB: EARLY WARNING (v2 style + v1 protocol) -->
        <section class="toolkit-section" id="tab-early-warning" role="tabpanel">
            <div class="container">
                <div class="section-header">
                    <span class="section-label">Real-time monitoring</span>
                    <h2 class="section-title">Early Warning <span class="gold-text">Signals</span></h2>
                    <p class="section-desc">Eight institutional-grade signals + Protocol triggers (T1-T5) monitored continuously.</p>
                </div>

                <!-- Protocol Triggers (from v1) -->
                <div class="protocol-container" id="protocolContainer"></div>

                <!-- Manual Flags (from v1) -->
                <div class="manual-flags" id="manualFlags">
                    <button class="flag-btn" id="flagASML">ASML Guidance Cut</button>
                    <button class="flag-btn" id="flagTaiwan">Taiwan Activity</button>
                    <button class="flag-btn" id="flagMSFT">Reduce MSFT</button>
                    <button class="flag-btn" id="flagNVDA">Exit NVDA</button>
                </div>

                <!-- Early Warning Grid (from v2) -->
                <div class="ew-grid" style="margin-top:2rem;" id="ewGrid">
                    <!-- Populated by JS -->
                </div>

                <!-- Alerts Feed -->
                <div class="ew-alerts" id="ewAlerts">
                    <div class="ew-alerts-header">Latest Alerts</div>
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- TAB: COMPANIES (v2 style + v1 data) -->
        <section class="toolkit-section" id="tab-companies" role="tabpanel">
            <div class="container">
                <div class="section-header">
                    <span class="section-label">Coverage Universe</span>
                    <h2 class="section-title">Company <span class="gold-text">Intelligence</span></h2>
                    <p class="section-desc">68 companies analyzed through the lens of bubble risk. Each card includes protection protocols.</p>
                </div>

                <div class="company-controls">
                    <div class="search-box">
                        <svg class="search-icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                        <input type="text" class="search-input" id="companySearch" placeholder="Search ticker or company name...">
                    </div>
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="tier-1">Tier 1</button>
                    <button class="filter-btn" data-filter="tier-2">Tier 2</button>
                    <button class="filter-btn" data-filter="tier-3">Tier 3</button>
                    <button class="filter-btn" data-filter="high-risk">High Risk</button>
                </div>

                <div class="companies-grid" id="companiesGrid"></div>
            </div>
        </section>

        <!-- TAB: CONTAGION MAP (v2) -->
        <section class="toolkit-section" id="tab-contagion" role="tabpanel">
            <div class="container">
                <div class="section-header">
                    <span class="section-label">Cascade Analysis</span>
                    <h2 class="section-title">Contagion <span class="gold-text">Map</span></h2>
                    <p class="section-desc">Model the cascading impact of an NVIDIA shock across the AI ecosystem. Drag the slider to simulate.</p>
                </div>

                <div class="contagion-controls">
                    <div class="contagion-slider-group">
                        <span class="contagion-slider-label">NVIDIA Shock Scenario</span>
                        <div class="contagion-slider-row">
                            <input type="range" class="contagion-slider" id="contagionSlider" min="0" max="70" value="40">
                            <span class="contagion-value color-red" id="contagionValue">-40%</span>
                        </div>
                    </div>
                </div>

                <div class="contagion-tiers" id="contagionTiers">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- TAB: DCF MODEL (v1) -->
        <section class="toolkit-section" id="tab-dcf" role="tabpanel">
            <div class="container-narrow">
                <div class="section-header">
                    <span class="section-label">Valuation Model</span>
                    <h2 class="section-title">NVIDIA <span class="gold-text">DCF</span></h2>
                    <p class="section-desc">Interactive discounted cash flow model with bubble-adjusted fair value.</p>
                </div>

                <div class="dcf-grid">
                    <div class="dcf-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:1.5rem;">
                            <h3 style="font-family:var(--font-display); font-weight:200;">Inputs</h3>
                            <button class="filter-btn" id="resetDCFBtn">Reset</button>
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="waccSlider">WACC (Discount Rate)</label>
                                <span class="slider-value" id="waccDisplay">8.5%</span>
                            </div>
                            <input type="range" id="waccSlider" min="5" max="15" step="0.1" value="8.5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="growthSlider">Revenue Growth (5yr)</label>
                                <span class="slider-value" id="growthDisplay">25%</span>
                            </div>
                            <input type="range" id="growthSlider" min="10" max="50" step="1" value="25">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="terminalSlider">Terminal Growth</label>
                                <span class="slider-value" id="terminalDisplay">2.5%</span>
                            </div>
                            <input type="range" id="terminalSlider" min="1" max="5" step="0.1" value="2.5">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <label for="fcfSlider">FCF Margin</label>
                                <span class="slider-value" id="fcfDisplay">25%</span>
                            </div>
                            <input type="range" id="fcfSlider" min="15" max="40" step="1" value="25">
                        </div>
                    </div>

                    <div class="dcf-card">
                        <h3 style="font-family:var(--font-display); font-weight:200; margin-bottom:1.5rem;">Results</h3>
                        <div class="metric-row"><span class="metric-label">Current Price</span><span class="metric-value value-gold" id="dcfPrice">—</span></div>
                        <div class="metric-row"><span class="metric-label">Fair Value (DCF)</span><span class="metric-value" id="fairValue">—</span></div>
                        <div class="metric-row"><span class="metric-label">Bubble-Adjusted FV</span><span class="metric-value" id="adjFairValue">—</span></div>
                        <div class="metric-row"><span class="metric-label">Upside/Downside</span><span class="metric-value" id="upside">—</span></div>
                        <div class="metric-row"><span class="metric-label">Recommendation</span><span class="metric-value" id="recommendation">—</span></div>

                        <div style="background:rgba(0,0,0,0.25); border-left:2px solid var(--gold); padding:1rem; margin-top:1rem;">
                            <h4 style="color:var(--gold); margin-bottom:0.5rem; font-size:0.85rem;">Analysis</h4>
                            <p id="dcfAnalysis" style="font-size:0.75rem; line-height:1.6;">Calculating...</p>
                        </div>
                    </div>
                </div>

                <div class="export-bar">
                    <button class="export-btn" id="exportDCF">
                        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Export Model
                    </button>
                </div>
            </div>
        </section>

        <!-- TAB: NEWS FEED (v1) -->
        <section class="toolkit-section" id="tab-news" role="tabpanel">
            <div class="container-narrow">
                <div class="section-header">
                    <span class="section-label">Sector Intelligence</span>
                    <h2 class="section-title">AI <span class="gold-text">News Feed</span></h2>
                    <p class="section-desc">Real-time RSS aggregation with sentiment analysis.</p>
                </div>

                <div class="news-controls">
                    <div class="news-stats" id="newsStats">
                        <div class="news-stat"><span class="news-dot dot-positive"></span> Positive: <span id="newsPositive">0</span></div>
                        <div class="news-stat"><span class="news-dot dot-negative"></span> Negative: <span id="newsNegative">0</span></div>
                        <div class="news-stat"><span class="news-dot dot-neutral"></span> Neutral: <span id="newsNeutral">0</span></div>
                    </div>
                    <button class="refresh-btn" id="refreshNewsBtn">↻ Refresh</button>
                </div>

                <div class="news-container" id="newsContainer">
                    <div style="text-align:center; padding:2rem; color:var(--text-dim);">Loading news...</div>
                </div>
            </div>
        </section>

        <!-- TAB: STRESS TEST (v2) -->
        <section class="toolkit-section" id="tab-stress-test" role="tabpanel">
            <div class="container-narrow">
                <div class="section-header">
                    <span class="section-label">Portfolio Analysis</span>
                    <h2 class="section-title">AI Exposure <span class="gold-text">Stress Test</span></h2>
                    <p class="section-desc">Enter your holdings to calculate total AI exposure and model drawdown scenarios.</p>
                </div>

                <div class="stress-input-area">
                    <div class="stress-input-title">Your Portfolio</div>
                    <div class="portfolio-inputs" id="portfolioInputs">
                        <div class="portfolio-input-group">
                            <label>NVDA %</label>
                            <input type="number" class="portfolio-input" data-ticker="NVDA" data-ai-beta="1.0" placeholder="0" min="0" max="100">
                        </div>
                        <div class="portfolio-input-group">
                            <label>AAPL %</label>
                            <input type="number" class="portfolio-input" data-ticker="AAPL" data-ai-beta="0.3" placeholder="0" min="0" max="100">
                        </div>
                        <div class="portfolio-input-group">
                            <label>MSFT %</label>
                            <input type="number" class="portfolio-input" data-ticker="MSFT" data-ai-beta="0.55" placeholder="0" min="0" max="100">
                        </div>
                        <div class="portfolio-input-group">
                            <label>GOOG %</label>
                            <input type="number" class="portfolio-input" data-ticker="GOOG" data-ai-beta="0.5" placeholder="0" min="0" max="100">
                        </div>
                        <div class="portfolio-input-group">
                            <label>AMZN %</label>
                            <input type="number" class="portfolio-input" data-ticker="AMZN" data-ai-beta="0.4" placeholder="0" min="0" max="100">
                        </div>
                        <div class="portfolio-input-group">
                            <label>AMD %</label>
                            <input type="number" class="portfolio-input" data-ticker="AMD" data-ai-beta="0.85" placeholder="0" min="0" max="100">
                        </div>
                        <div class="portfolio-input-group">
                            <label>META %</label>
                            <input type="number" class="portfolio-input" data-ticker="META" data-ai-beta="0.45" placeholder="0" min="0" max="100">
                        </div>
                        <div class="portfolio-input-group">
                            <label>Other %</label>
                            <input type="number" class="portfolio-input" data-ticker="OTHER" data-ai-beta="0.1" placeholder="0" min="0" max="100">
                        </div>
                    </div>
                    <button class="stress-btn" id="runStressTest">Run Stress Test</button>
                </div>

                <div class="stress-results" id="stressResults">
                    <div class="stress-exposure">
                        <div class="exposure-value" id="exposureValue">0%</div>
                        <div class="exposure-label">Total AI Exposure</div>
                        <span class="bic-signal" id="exposureSignal"></span>
                    </div>

                    <div class="stress-scenarios">
                        <div class="stress-scenario">
                            <div class="scenario-name">Soft Landing</div>
                            <div class="scenario-shock">AI Sector: -20%</div>
                            <div class="scenario-result color-orange" id="scenarioSoft">—</div>
                        </div>
                        <div class="stress-scenario">
                            <div class="scenario-name">Hard Correction</div>
                            <div class="scenario-shock">AI Sector: -40%</div>
                            <div class="scenario-result color-red" id="scenarioHard">—</div>
                        </div>
                        <div class="stress-scenario">
                            <div class="scenario-name">Dot-com Replay</div>
                            <div class="scenario-shock">AI Sector: -70%</div>
                            <div class="scenario-result color-red" id="scenarioDotcom">—</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: HISTORICAL OVERLAY (v2) -->
        <section class="toolkit-section" id="tab-history" role="tabpanel">
            <div class="container">
                <div class="section-header">
                    <span class="section-label">Pattern Recognition</span>
                    <h2 class="section-title">Historical <span class="gold-text">Overlay</span></h2>
                    <p class="section-desc">Current AI cycle mapped against the Dot-com bubble (1995–2002). Time-indexed comparison.</p>
                </div>

                <div class="history-chart-container">
                    <div class="history-chart">
                        <canvas id="historyCanvas"></canvas>
                    </div>
                </div>

                <div class="history-position">
                    <div class="hp-item">
                        <div class="hp-value" id="currentMonth">Month 38</div>
                        <div class="hp-label">Current cycle position</div>
                    </div>
                    <div class="hp-item">
                        <div class="hp-value" id="dotcomEquivalent">Oct 1998</div>
                        <div class="hp-label">Dot-com equivalent</div>
                    </div>
                    <div class="hp-item">
                        <div class="hp-value color-orange" id="runway">~18 months</div>
                        <div class="hp-label">Est. runway to structural risk</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB: METHODOLOGY (v2) -->
        <section class="toolkit-section" id="tab-methodology" role="tabpanel">
            <div class="container-narrow">
                <div class="section-header">
                    <span class="section-label">Transparency</span>
                    <h2 class="section-title"><span class="gold-text">Methodology</span></h2>
                    <p class="section-desc">The NWA AI Bubble Index™ is composed of 12 quantitative factors weighted by predictive power.</p>
                </div>

                <div class="methodology-grid" id="methodologyGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="toolkit-footer">
        <div class="container">
            <div class="toolkit-footer-inner">
                <p>&copy; <span id="year"></span> North West Atlas B Corp. All rights reserved. For informational purposes only.</p>
                <div>
                    <a href="index.html">Main Site</a> &nbsp;&middot;&nbsp;
                    <a href="disclosures.html">Disclosures</a> &nbsp;&middot;&nbsp;
                    <a href="#" id="settingsLink">Settings</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings</h3>
            </div>
            <div class="form-group">
                <label for="fmpKey">FMP API Key</label>
                <input type="text" id="fmpKey" placeholder="demo" autocomplete="off">
                <small>Get free key at financialmodelingprep.com</small>
            </div>
            <div class="form-group">
                <label for="alphaKey">Alpha Vantage API Key (fallback)</label>
                <input type="text" id="alphaKey" placeholder="optional" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="refreshInterval">Auto-Refresh Interval (minutes)</label>
                <input type="number" id="refreshInterval" min="1" max="60" value="5">
            </div>
            <div class="form-group">
                <label>Auto-Refresh</label>
                <button class="filter-btn" id="autoRefreshToggle" style="width:100%;">ON</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" id="cancelSettingsBtn">Cancel</button>
                <button class="modal-btn primary" id="saveSettingsBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Detail Panel -->
    <aside class="detail-panel" id="detailPanel">
        <div class="panel-header">
            <h3 id="detailTitle">—</h3>
            <button class="close-btn" id="closeDetailBtn">
                <svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <div id="detailContent"></div>
    </aside>

    <script>
        (function() {
            'use strict';

            // === COPY PROTECTION ===
            document.addEventListener('contextmenu', e => e.preventDefault());
            document.addEventListener('copy', e => e.preventDefault());
            document.addEventListener('cut', e => e.preventDefault());
            document.addEventListener('dragstart', e => e.preventDefault());

            // === CONFIG ===
            const CONFIG = {
                proxies: [
                    'https://nwa-cors-proxy.ceo-northwestatlas-bcorp.workers.dev/?url=',
                    'https://corsproxy.io/?',
                    'https://api.allorigins.win/raw?url='
                ],
                currentProxy: 0,
                refreshInterval: parseInt(localStorage.getItem('refreshInterval') || '5') * 60000,
                apiKeys: {
                    fmp: localStorage.getItem('fmp_key') || 'demo',
                    alpha: localStorage.getItem('alpha_key') || ''
                },
                autoRefresh: localStorage.getItem('autoRefresh') !== 'false',
                manualFlags: {
                    asml: localStorage.getItem('flag_asml') === 'true',
                    taiwan: localStorage.getItem('flag_taiwan') === 'true',
                    msft: localStorage.getItem('flag_msft') === 'true',
                    nvda: localStorage.getItem('flag_nvda') === 'true'
                }
            };

            // === AI COMPANIES (68) ===
            const AI_COMPANIES = [
                {symbol:'NVDA',name:'NVIDIA Corporation',sector:'Semiconductors'},
                {symbol:'AMD',name:'Advanced Micro Devices',sector:'Semiconductors'},
                {symbol:'AVGO',name:'Broadcom Inc.',sector:'Semiconductors'},
                {symbol:'QCOM',name:'Qualcomm Inc.',sector:'Semiconductors'},
                {symbol:'INTC',name:'Intel Corporation',sector:'Semiconductors'},
                {symbol:'MRVL',name:'Marvell Technology',sector:'Semiconductors'},
                {symbol:'ARM',name:'Arm Holdings',sector:'Semiconductors'},
                {symbol:'TSM',name:'Taiwan Semiconductor',sector:'Semiconductors'},
                {symbol:'ASML',name:'ASML Holding',sector:'Semiconductors'},
                {symbol:'MU',name:'Micron Technology',sector:'Semiconductors'},
                {symbol:'NXPI',name:'NXP Semiconductors',sector:'Semiconductors'},
                {symbol:'ON',name:'ON Semiconductor',sector:'Semiconductors'},
                {symbol:'MCHP',name:'Microchip Technology',sector:'Semiconductors'},
                {symbol:'ADI',name:'Analog Devices',sector:'Semiconductors'},
                {symbol:'TXN',name:'Texas Instruments',sector:'Semiconductors'},
                {symbol:'STM',name:'STMicroelectronics',sector:'Semiconductors'},
                {symbol:'IFNNY',name:'Infineon Technologies',sector:'Semiconductors'},
                {symbol:'POWI',name:'Power Integrations',sector:'Semiconductors'},
                {symbol:'MSFT',name:'Microsoft Corporation',sector:'Cloud'},
                {symbol:'GOOGL',name:'Alphabet Inc.',sector:'Cloud'},
                {symbol:'AMZN',name:'Amazon.com Inc.',sector:'Cloud'},
                {symbol:'META',name:'Meta Platforms',sector:'Cloud'},
                {symbol:'ORCL',name:'Oracle Corporation',sector:'Cloud'},
                {symbol:'IBM',name:'IBM Corporation',sector:'Cloud'},
                {symbol:'CRM',name:'Salesforce Inc.',sector:'Cloud'},
                {symbol:'SNOW',name:'Snowflake Inc.',sector:'Cloud'},
                {symbol:'DDOG',name:'Datadog Inc.',sector:'Cloud'},
                {symbol:'NET',name:'Cloudflare Inc.',sector:'Cloud'},
                {symbol:'BABA',name:'Alibaba Group',sector:'Cloud'},
                {symbol:'BIDU',name:'Baidu Inc.',sector:'Cloud'},
                {symbol:'TCEHY',name:'Tencent Holdings',sector:'Cloud'},
                {symbol:'WDAY',name:'Workday Inc.',sector:'Cloud'},
                {symbol:'PLTR',name:'Palantir Technologies',sector:'Software'},
                {symbol:'AI',name:'C3.ai Inc.',sector:'Software'},
                {symbol:'BBAI',name:'BigBear.ai Holdings',sector:'Software'},
                {symbol:'SOUN',name:'SoundHound AI',sector:'Software'},
                {symbol:'PATH',name:'UiPath Inc.',sector:'Software'},
                {symbol:'ADBE',name:'Adobe Inc.',sector:'Software'},
                {symbol:'NOW',name:'ServiceNow Inc.',sector:'Software'},
                {symbol:'PANW',name:'Palo Alto Networks',sector:'Software'},
                {symbol:'CRWD',name:'CrowdStrike Holdings',sector:'Software'},
                {symbol:'ZS',name:'Zscaler Inc.',sector:'Software'},
                {symbol:'OKTA',name:'Okta Inc.',sector:'Software'},
                {symbol:'MDB',name:'MongoDB Inc.',sector:'Software'},
                {symbol:'SNPS',name:'Synopsys Inc.',sector:'Software'},
                {symbol:'CDNS',name:'Cadence Design Systems',sector:'Software'},
                {symbol:'SMCI',name:'Super Micro Computer',sector:'Hardware'},
                {symbol:'DELL',name:'Dell Technologies',sector:'Hardware'},
                {symbol:'HPE',name:'Hewlett Packard Enterprise',sector:'Hardware'},
                {symbol:'ANET',name:'Arista Networks',sector:'Hardware'},
                {symbol:'NTAP',name:'NetApp Inc.',sector:'Hardware'},
                {symbol:'PSTG',name:'Pure Storage',sector:'Hardware'},
                {symbol:'WDC',name:'Western Digital',sector:'Hardware'},
                {symbol:'STX',name:'Seagate Technology',sector:'Hardware'},
                {symbol:'JNPR',name:'Juniper Networks',sector:'Hardware'},
                {symbol:'CSCO',name:'Cisco Systems',sector:'Hardware'},
                {symbol:'KEYS',name:'Keysight Technologies',sector:'Hardware'},
                {symbol:'COHR',name:'Coherent Corp.',sector:'Hardware'},
                {symbol:'AMAT',name:'Applied Materials',sector:'Equipment'},
                {symbol:'LRCX',name:'Lam Research',sector:'Equipment'},
                {symbol:'KLAC',name:'KLA Corporation',sector:'Equipment'},
                {symbol:'TER',name:'Teradyne Inc.',sector:'Equipment'},
                {symbol:'AEHR',name:'Aehr Test Systems',sector:'Equipment'},
                {symbol:'ACMR',name:'ACM Research',sector:'Equipment'},
                {symbol:'VECO',name:'Veeco Instruments',sector:'Equipment'},
                {symbol:'UCTT',name:'Ultra Clean Holdings',sector:'Equipment'},
                {symbol:'ICHR',name:'Ichor Holdings',sector:'Equipment'},
                {symbol:'CAMT',name:'Camtek Ltd.',sector:'Equipment'}
            ];

            // === UTILITIES ===
            const utils = {
                formatCurrency: (num) => num == null ? '—' : new Intl.NumberFormat('en-US', {style:'currency',currency:'USD'}).format(num),
                formatPercent: (num, d=1) => num == null ? '—' : (num > 0 ? '+' : '') + num.toFixed(d) + '%',
                formatNumber: (num, d=2) => num == null ? '—' : num.toFixed(d),
                showLoading: (show, text='Loading...') => {
                    const el = document.getElementById('loadingOverlay');
                    document.getElementById('loadingText').textContent = text;
                    el.classList.toggle('active', show);
                },
                showToast: (message, type='info') => {
                    const existing = document.querySelector('.toast');
                    if (existing) existing.remove();
                    const toast = document.createElement('div');
                    toast.className = `toast ${type}`;
                    toast.innerHTML = message;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 3000);
                },
                debounce: (fn, wait) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => fn.apply(this, args), wait);
                    };
                }
            };

            // === CACHE MANAGER ===
            class CacheManager {
                constructor(prefix='nwa_v5_') { this.prefix = prefix; }
                get(key, maxAge=300) {
                    try {
                        const item = localStorage.getItem(this.prefix + key);
                        if (!item) return null;
                        const parsed = JSON.parse(item);
                        if ((Date.now() - parsed.timestamp) / 1000 > maxAge) {
                            localStorage.removeItem(this.prefix + key);
                            return null;
                        }
                        return parsed.value;
                    } catch { return null; }
                }
                set(key, value) {
                    try {
                        localStorage.setItem(this.prefix + key, JSON.stringify({value, timestamp: Date.now()}));
                    } catch {}
                }
            }
            const cache = new CacheManager();

            // === REQUEST QUEUE ===
            class RequestQueue {
                constructor(max=3) { this.max = max; this.running = 0; this.queue = []; }
                add(fn, priority=0) {
                    return new Promise((resolve, reject) => {
                        this.queue.push({fn, resolve, reject, priority});
                        this.queue.sort((a,b) => b.priority - a.priority);
                        this._next();
                    });
                }
                _next() {
                    if (this.running >= this.max || !this.queue.length) return;
                    const item = this.queue.shift();
                    this.running++;
                    item.fn().then(item.resolve).catch(item.reject).finally(() => {
                        this.running--;
                        this._next();
                    });
                }
            }
            const requestQueue = new RequestQueue(3);

            // === API ===
            const api = {
                async fetchWithProxy(url, retries=3) {
                    for (let attempt = 0; attempt < retries; attempt++) {
                        try {
                            const direct = await fetch(url, {headers:{'Accept':'application/json'}, signal:AbortSignal.timeout(8000)});
                            if (direct.ok) return direct;
                        } catch {}
                        for (let p = 0; p < CONFIG.proxies.length; p++) {
                            try {
                                const proxyUrl = CONFIG.proxies[p] + encodeURIComponent(url);
                                const response = await fetch(proxyUrl, {signal:AbortSignal.timeout(10000)});
                                if (response.ok) { CONFIG.currentProxy = p; return response; }
                            } catch {}
                        }
                        if (attempt < retries-1) await new Promise(r => setTimeout(r, 1000*Math.pow(2, attempt)));
                    }
                    throw new Error('Failed to fetch ' + url);
                },
                fetchYahooQuote(symbol) {
                    const cacheKey = 'quote_' + symbol;
                    const cached = cache.get(cacheKey, 30);
                    if (cached) return Promise.resolve(cached);
                    const yahooMap = {'NDX':'^NDX','GSPC':'^GSPC','VIX':'^VIX','DXY':'DX-Y.NYB'};
                    const ySymbol = yahooMap[symbol] || symbol;
                    const url = 'https://query1.finance.yahoo.com/v8/finance/chart/' + ySymbol + '?interval=1m&range=1d';
                    return requestQueue.add(async () => {
                        try {
                            const response = await this.fetchWithProxy(url);
                            const data = await response.json();
                            const meta = data.chart?.result[0]?.meta;
                            if (!meta) throw new Error('No metadata');
                            const price = parseFloat(meta.regularMarketPrice);
                            const prevClose = parseFloat(meta.chartPreviousClose || meta.previousClose || price);
                            const change = price - prevClose;
                            const changePercent = (change / prevClose) * 100;
                            const quote = {price, change, changePercent, timestamp:Date.now()};
                            cache.set(cacheKey, quote);
                            localStorage.setItem('fallback_' + symbol, JSON.stringify(quote));
                            return quote;
                        } catch {
                            const fallback = localStorage.getItem('fallback_' + symbol);
                            return fallback ? JSON.parse(fallback) : null;
                        }
                    }, symbol === 'NDX' ? 5 : 1);
                },
                fetchDailyCloses(symbol, range='1mo') {
                    const cacheKey = 'daily_' + symbol + '_' + range;
                    const cached = cache.get(cacheKey, 300);
                    if (cached) return Promise.resolve(cached);
                    const yahooMap = {'NDX':'^NDX','GSPC':'^GSPC'};
                    const ySymbol = yahooMap[symbol] || symbol;
                    const url = 'https://query1.finance.yahoo.com/v8/finance/chart/' + ySymbol + '?interval=1d&range=' + range;
                    return (async () => {
                        try {
                            const response = await this.fetchWithProxy(url);
                            const data = await response.json();
                            const closes = (data.chart.result[0].indicators.quote[0].close || []).filter(v => v != null);
                            cache.set(cacheKey, closes);
                            return closes;
                        } catch { return []; }
                    })();
                },
                async fetchRSS() {
                    const feeds = [
                        'https://techcrunch.com/tag/artificial-intelligence/feed/',
                        'https://www.wired.com/feed/tag/ai/latest/rss',
                        'https://www.theverge.com/rss/ai-artificial-intelligence/index.xml'
                    ];
                    const items = [];
                    for (const feed of feeds) {
                        try {
                            const response = await this.fetchWithProxy(feed);
                            const text = await response.text();
                            const xml = new DOMParser().parseFromString(text, 'text/xml');
                            xml.querySelectorAll('item').forEach(item => {
                                const title = item.querySelector('title')?.textContent || '';
                                const link = item.querySelector('link')?.textContent || '';
                                const desc = item.querySelector('description')?.textContent || '';
                                const pubDate = item.querySelector('pubDate')?.textContent;
                                const content = (title + ' ' + desc).toLowerCase();
                                const posWords = ['positive','bullish','gain','surge','rally','beat','strong','growth'];
                                const negWords = ['negative','bearish','loss','decline','drop','miss','weak','risk'];
                                const posCount = posWords.filter(w => content.includes(w)).length;
                                const negCount = negWords.filter(w => content.includes(w)).length;
                                const sentiment = posCount > negCount ? 'positive' : negCount > posCount ? 'negative' : 'neutral';
                                items.push({
                                    title: title.trim(),
                                    link: link.trim(),
                                    summary: desc.replace(/<[^>]*>/g, '').trim().substring(0, 200) + '…',
                                    source: new URL(feed).hostname.replace('www.', ''),
                                    date: pubDate ? new Date(pubDate) : new Date(),
                                    sentiment
                                });
                            });
                        } catch {}
                    }
                    return items.sort((a,b) => b.date - a.date).slice(0, 30);
                }
            };

            // === CALCULATIONS ===
            const calc = {
                bubbleScore: (price, changePercent, vol=0.3) => {
                    if (!price) return 5;
                    const momentum = Math.abs(changePercent) / 10;
                    const volatility = vol * 10;
                    return Math.min(10, Math.max(1, parseFloat((5 + momentum + volatility).toFixed(1))));
                },
                crisisProb: (vix, corr=0.6) => {
                    if (!vix) return 45;
                    const vixFactor = Math.min(1, (vix - 12) / 40);
                    return Math.min(95, Math.round((vixFactor * 0.6 + corr * 0.4) * 100));
                },
                cci: (vix, prev=0.5, curr=0.6) => {
                    if (!vix) return 0.12;
                    return Math.min(0.5, Math.max(0, parseFloat(((curr - prev) * vix / 20).toFixed(3))));
                },
                async evaluateProtocol() {
                    const ndxCloses = await api.fetchDailyCloses('NDX', '1mo');
                    const vix = (state.market.vix?.price) || 20;
                    if (ndxCloses.length < 5) return state.protocol;
                    const checkDrawdown = (days, threshold) => {
                        const recent = ndxCloses.slice(-days);
                        const peak = Math.max(...recent);
                        const current = recent[recent.length - 1];
                        return ((current - peak) / peak) * 100 <= threshold;
                    };
                    return {
                        t1: checkDrawdown(3, -20) || vix > 25,
                        t2: checkDrawdown(2, -30) || vix > 30,
                        t3: checkDrawdown(1, -40) || vix > 35,
                        t4: checkDrawdown(1, -50) || vix > 40,
                        t5: checkDrawdown(5, -60) && vix > 50
                    };
                },
                dcf(params) {
                    let fcf = params.revenue * (params.fcfMargin / 100);
                    let npv = 0;
                    for (let y = 1; y <= 5; y++) {
                        fcf *= (1 + params.growth / 100);
                        npv += fcf / Math.pow(1 + params.wacc / 100, y);
                    }
                    const termFCF = fcf * (1 + params.terminal / 100);
                    const tv = termFCF / ((params.wacc - params.terminal) / 100);
                    npv += tv / Math.pow(1 + params.wacc / 100, 5);
                    return npv / params.shares;
                },
                bubbleIndex: () => {
                    if (!state.heatmap.length) return 73;
                    const scores = state.heatmap.map(c => c.score);
                    const avg = scores.reduce((a,b) => a + b, 0) / scores.length;
                    return Math.round((avg / 10) * 100);
                }
            };

            // === STATE ===
            const state = {
                market: {},
                stocks: {},
                heatmap: [],
                news: [],
                protocol: {t1:false, t2:false, t3:false, t4:false, t5:false},
                autoRefresh: CONFIG.autoRefresh,
                charts: {}
            };

            // === LOADERS ===
            const loaders = {
                async loadMarketData() {
                    const indices = ['NDX','GSPC','VIX','DXY'];
                    const results = await Promise.allSettled(indices.map(s => api.fetchYahooQuote(s)));
                    results.forEach((r,i) => {
                        if (r.status === 'fulfilled' && r.value) state.market[indices[i].toLowerCase()] = r.value;
                    });
                    ui.updateDashboard();
                },
                async loadStockData() {
                    const stocks = ['NVDA','AMD','MSFT','GOOGL','META','AMZN','AVGO','SMCI','PLTR'];
                    const results = await Promise.allSettled(stocks.map(s => api.fetchYahooQuote(s)));
                    results.forEach((r,i) => {
                        if (r.status === 'fulfilled' && r.value) state.stocks[stocks[i]] = r.value;
                    });
                    ui.updateDashboard();
                    ui.updateDCF();
                },
                async loadHeatmapData() {
                    utils.showLoading(true, 'Loading 68 AI companies...');
                    state.heatmap = [];
                    for (let i = 0; i < AI_COMPANIES.length; i += 10) {
                        const batch = AI_COMPANIES.slice(i, i + 10);
                        const results = await Promise.allSettled(batch.map(c => api.fetchYahooQuote(c.symbol)));
                        results.forEach((r, j) => {
                            if (r.status === 'fulfilled' && r.value) {
                                const c = batch[j], q = r.value;
                                state.heatmap.push({
                                    ...c,
                                    ...q,
                                    score: calc.bubbleScore(q.price, q.changePercent)
                                });
                            }
                        });
                        ui.renderCompanies();
                        await new Promise(r => setTimeout(r, 200));
                    }
                    utils.showLoading(false);
                    ui.updateBubbleIndex();
                    utils.showToast(`Loaded ${state.heatmap.length} companies`, 'success');
                },
                async loadNews() {
                    utils.showLoading(true, 'Fetching news...');
                    state.news = await api.fetchRSS();
                    ui.renderNews();
                    utils.showLoading(false);
                },
                async loadProtocol() {
                    state.protocol = await calc.evaluateProtocol();
                    ui.renderProtocol();
                },
                async loadAll() {
                    utils.showLoading(true, 'Initializing...');
                    await this.loadMarketData();
                    await this.loadStockData();
                    await this.loadProtocol();
                    utils.showLoading(false);
                }
            };

            // === UI ===
            const ui = {
                updateHeader() {
                    const vix = state.market.vix?.price || 20;
                    const cci = calc.cci(vix);
                    const crisis = calc.crisisProb(vix);
                    const nvda = state.stocks.NVDA;
                    const bubble = nvda ? calc.bubbleScore(nvda.price, nvda.changePercent) : 5;
                },
                updateDashboard() {
                    // Market Snapshot
                    const marketHTML = Object.entries(state.market).map(([key, data]) => {
                        if (!data) return '';
                        const cls = data.change >= 0 ? 'color-green' : 'color-red';
                        return `<div class="metric-row"><span class="metric-label">${key.toUpperCase()}</span><span class="metric-value ${cls}">${utils.formatCurrency(data.price)} (${utils.formatPercent(data.changePercent)})</span></div>`;
                    }).join('');
                    document.getElementById('marketSnapshot').innerHTML = marketHTML || '<div class="metric-row">No data</div>';

                    // AI Leaders
                    const topStocks = Object.entries(state.stocks).filter(([,v]) => v).slice(0,5);
                    document.getElementById('aiLeaders').innerHTML = topStocks.map(([k,v]) => {
                        const cls = v.change >= 0 ? 'color-green' : 'color-red';
                        return `<div class="metric-row"><span class="metric-label">${k}</span><span class="metric-value ${cls}">${utils.formatCurrency(v.price)} (${utils.formatPercent(v.changePercent)})</span></div>`;
                    }).join('');

                    // Risk Metrics
                    const vix = state.market.vix?.price || 20;
                    document.getElementById('riskMetrics').innerHTML = `
                        <div class="metric-row"><span>VIX</span><span class="metric-value ${vix > 25 ? 'color-red' : vix > 20 ? 'color-orange' : 'color-green'}">${utils.formatNumber(vix,2)}</span></div>
                        <div class="metric-row"><span>Crisis Probability</span><span class="metric-value ${vix > 25 ? 'color-red' : 'color-orange'}">${calc.crisisProb(vix)}%</span></div>
                        <div class="metric-row"><span>CCI</span><span class="metric-value">${utils.formatNumber(calc.cci(vix),3)}</span></div>
                    `;

                    // Protocol Status
                    const activeCount = Object.values(state.protocol).filter(Boolean).length;
                    document.getElementById('protocolStatus').innerHTML = `
                        <div class="metric-row"><span>Active Triggers</span><span class="metric-value ${activeCount > 0 ? 'color-red' : 'color-green'}">${activeCount}/5</span></div>
                        <div class="metric-row"><span>Current Regime</span><span class="metric-value color-gold">${activeCount === 0 ? 'PEAK' : activeCount > 3 ? 'CRISIS' : 'CAUTION'}</span></div>
                    `;

                    // Quick Stats
                    document.getElementById('quickStats').innerHTML = `
                        <div class="metric-row"><span>VIX</span><span class="metric-value">${utils.formatNumber(vix,1)}</span></div>
                        <div class="metric-row"><span>NASDAQ</span><span class="metric-value">${state.market.ndx ? utils.formatNumber(state.market.ndx.price,0) : '—'}</span></div>
                        <div class="metric-row"><span>NVDA</span><span class="metric-value">${utils.formatCurrency(state.stocks.NVDA?.price)}</span></div>
                    `;

                    // Executive Summary
                    const vixLevel = vix > 30 ? 'elevated' : vix > 20 ? 'moderate' : 'low';
                    const regime = vix > 30 ? 'CRISIS' : vix > 25 ? 'CORRECTION' : vix > 20 ? 'CAUTION' : 'EXPANSION';
                    document.getElementById('regimeBadge').textContent = regime;
                    document.getElementById('confidenceBadge').textContent = vix < 20 ? 'HIGH' : vix < 25 ? 'MEDIUM' : 'LOW';

                    document.getElementById('executiveSummary').innerHTML = `Current market regime shows <strong style="color:var(--gold-light);">${vixLevel}</strong> volatility (VIX: ${utils.formatNumber(vix,2)}). AI sector correlation remains ${calc.cci(vix) > 0.15 ? 'elevated' : 'moderate'} with CCI at ${utils.formatNumber(calc.cci(vix),3)}. Crisis probability estimated at <strong style="color:${calc.crisisProb(vix) > 60 ? 'var(--red-soft)' : 'var(--orange)'};">${calc.crisisProb(vix)}%</strong> within 6 months.${activeCount > 0 ? `<br><br><strong style="color:var(--red-soft);">⚠ ${activeCount} protocol trigger(s) active.</strong>` : ''}`;

                    document.getElementById('executiveActions').innerHTML = vix > 30
                        ? '• <strong>Execute risk reduction immediately</strong><br>• Activate hedging strategies<br>• Increase cash to 40%+<br>• Review stop-losses'
                        : vix > 25
                        ? '• Monitor positions closely<br>• Consider partial profit-taking<br>• Increase cash reserves to 20–30%<br>• Prepare contingency plans'
                        : '• Maintain current allocation<br>• Monitor key support levels<br>• Review portfolio hedges<br>• Prepare trigger action plans';
                },
                updateBubbleIndex() {
                    if (!state.heatmap.length) return;
                    const index = calc.bubbleIndex();
                    document.getElementById('bicScore').textContent = index;
                    document.getElementById('bicGauge').style.width = index + '%';

                    let signal, signalClass;
                    if (index >= 75) { signal = 'Critical'; signalClass = 'signal-high'; }
                    else if (index >= 60) { signal = 'Elevated'; signalClass = 'signal-elevated'; }
                    else if (index >= 45) { signal = 'Moderate'; signalClass = 'signal-moderate'; }
                    else { signal = 'Low'; signalClass = 'signal-low'; }
                    const signalEl = document.getElementById('bicSignal');
                    signalEl.textContent = signal;
                    signalEl.className = `bic-signal ${signalClass}`;

                    const prev = localStorage.getItem('prev_bubble') ? parseInt(localStorage.getItem('prev_bubble')) : index - 5;
                    const trend = index > prev ? '↑ Rising' : index < prev ? '↓ Falling' : '→ Flat';
                    document.getElementById('bicTrend').innerHTML = `Trend: <span class="${index > prev ? 'up' : index < prev ? 'down' : ''}">${trend}</span>`;
                    localStorage.setItem('prev_bubble', index);

                    // Components
                    const components = [
                        { name: 'Valuation spread', value: Math.min(100, Math.round(index * 1.1)) },
                        { name: 'Retail sentiment', value: Math.min(100, Math.round(index * 1.08)) },
                        { name: 'Insider selling', value: Math.min(100, Math.round(index * 0.98)) },
                        { name: 'Capex sustainability', value: Math.min(100, Math.round(index * 0.93)) },
                        { name: 'Revenue quality', value: Math.min(100, Math.round(index * 0.88)) }
                    ];
                    document.getElementById('bicComponents').innerHTML = components.map(c => `
                        <div class="bic-comp-row">
                            <span class="bic-comp-name">${c.name}</span>
                            <div class="bic-comp-bar"><div class="bic-comp-bar-fill" style="width:${c.value}%; background:${c.value > 75 ? 'var(--red-soft)' : c.value > 50 ? 'var(--orange)' : 'var(--green)'};"></div></div>
                            <span class="bic-comp-value" style="color:${c.value > 75 ? 'var(--red-soft)' : c.value > 50 ? 'var(--orange)' : 'var(--green)'};">${c.value}</span>
                        </div>
                    `).join('');
                },
                renderCompanies() {
                    const grid = document.getElementById('companiesGrid');
                    if (!grid) return;
                    if (!state.heatmap.length) {
                        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:3rem; color:var(--text-dim);">Loading companies...</div>';
                        return;
                    }
                    const companies = state.heatmap.map(c => ({
                        ticker: c.symbol,
                        name: c.name,
                        sector: c.sector,
                        score: Math.round(c.score * 10),
                        price: c.price,
                        change: c.changePercent,
                        tier: c.symbol === 'NVDA' || c.symbol === 'AMD' || c.symbol === 'AVGO' ? 1 :
                              c.symbol === 'MSFT' || c.symbol === 'GOOGL' || c.symbol === 'AMZN' ? 2 : 3,
                        question: c.score > 8 ? 'Valuation disconnected from fundamentals?' :
                                  c.score > 6 ? 'Can growth justify current multiple?' :
                                  'Is downside protected?',
                        flags: c.score > 8 ? ['High bubble risk', 'Insider selling elevated'] :
                               c.score > 6 ? ['Moderate risk', 'Monitor closely'] :
                               ['Stable', 'Institutional grade'],
                        thesis: c.score > 8 ? 'reduce' : c.score > 6 ? 'hold' : 'accumulate'
                    })).slice(0, 20); // Limit for performance

                    grid.innerHTML = companies.map(c => {
                        const scoreColor = c.score >= 75 ? 'var(--red-soft)' : c.score >= 50 ? 'var(--orange)' : 'var(--green)';
                        const thesisClass = `thesis-${c.thesis}`;
                        return `
                            <div class="company-card" data-ticker="${c.ticker}">
                                <div class="cc-header">
                                    <div><div class="cc-ticker">${c.ticker}</div><div class="cc-name">${c.name}</div></div>
                                    <span class="cc-tier">Tier ${c.tier}</span>
                                </div>
                                <div class="cc-score-row">
                                    <div class="cc-bubble-score" style="color:${scoreColor}">${c.score}</div>
                                    <div class="cc-score-gauge"><div class="cc-score-gauge-fill" style="width:${c.score}%;background:${scoreColor}"></div></div>
                                </div>
                                <div class="cc-key-question">“${c.question}”</div>
                                <div class="cc-flags">
                                    ${c.flags.map(f => `<div class="cc-flag"><span class="cc-flag-icon">⚠</span>${f}</div>`).join('')}
                                </div>
                                <div class="cc-footer">
                                    <span class="cc-pe">${utils.formatCurrency(c.price)} (${utils.formatPercent(c.change)})</span>
                                    <span class="cc-thesis ${thesisClass}">${c.thesis}</span>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Add click handlers
                    document.querySelectorAll('.company-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const ticker = card.dataset.ticker;
                            const company = state.heatmap.find(c => c.symbol === ticker);
                            if (company) ui.showDetail(company);
                        });
                    });

                    document.getElementById('companiesTracked').textContent = state.heatmap.length;
                },
                renderProtocol() {
                    const container = document.getElementById('protocolContainer');
                    if (!container) return;
                    const triggers = [
                        {level:'T1', desc:'NDX -20% over 3 days OR VIX > 25', active:state.protocol.t1},
                        {level:'T2', desc:'NDX -30% over 2 days OR VIX > 30', active:state.protocol.t2},
                        {level:'T3', desc:'NDX -40% in 1 day OR VIX > 35', active:state.protocol.t3},
                        {level:'T4', desc:'NDX -50% in 1 day OR VIX > 40', active:state.protocol.t4},
                        {level:'T5', desc:'NDX -60% over 5 days AND VIX > 50', active:state.protocol.t5}
                    ];
                    container.innerHTML = triggers.map(t => `
                        <div class="protocol-item ${t.active ? 'triggered' : ''}">
                            <div class="protocol-level">${t.level}</div>
                            <div class="protocol-desc">${t.desc}</div>
                            <div class="protocol-status ${t.active ? 'status-triggered' : 'status-active'}">${t.active ? 'TRIGGERED' : 'INACTIVE'}</div>
                        </div>
                    `).join('');
                },
                renderNews() {
                    const container = document.getElementById('newsContainer');
                    if (!container) return;
                    if (!state.news.length) {
                        container.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-dim);">No news available</div>';
                        return;
                    }
                    container.innerHTML = state.news.map(item => `
                        <div class="news-item" onclick="window.open('${item.link}','_blank')">
                            <div class="news-title">${item.title}</div>
                            <div class="news-meta">
                                <span>${item.source}</span>
                                <span>${item.date.toLocaleDateString()}</span>
                                <span class="news-sentiment sentiment-${item.sentiment}">${item.sentiment}</span>
                            </div>
                            <div class="news-summary">${item.summary}</div>
                        </div>
                    `).join('');
                    const counts = {positive:0, negative:0, neutral:0};
                    state.news.forEach(n => counts[n.sentiment]++);
                    document.getElementById('newsPositive').textContent = counts.positive;
                    document.getElementById('newsNegative').textContent = counts.negative;
                    document.getElementById('newsNeutral').textContent = counts.neutral;
                },
                updateDCF() {
                    const wacc = parseFloat(document.getElementById('waccSlider').value);
                    const growth = parseFloat(document.getElementById('growthSlider').value);
                    const terminal = parseFloat(document.getElementById('terminalSlider').value);
                    const fcfMargin = parseFloat(document.getElementById('fcfSlider').value);
                    document.getElementById('waccDisplay').textContent = wacc.toFixed(1) + '%';
                    document.getElementById('growthDisplay').textContent = growth.toFixed(0) + '%';
                    document.getElementById('terminalDisplay').textContent = terminal.toFixed(1) + '%';
                    document.getElementById('fcfDisplay').textContent = fcfMargin.toFixed(0) + '%';
                    const nvda = state.stocks.NVDA;
                    if (!nvda) return;
                    const fv = calc.dcf({revenue:60.92, wacc, growth, terminal, fcfMargin, shares:2.46});
                    const bs = calc.bubbleScore(nvda.price, nvda.changePercent);
                    const adj = Math.max(0.5, Math.min(1, 1 - (bs - 5) * 0.08));
                    const adjFV = fv * adj;
                    const upside = ((adjFV - nvda.price) / nvda.price) * 100;
                    document.getElementById('dcfPrice').textContent = utils.formatCurrency(nvda.price);
                    document.getElementById('fairValue').textContent = utils.formatCurrency(fv);
                    document.getElementById('adjFairValue').textContent = utils.formatCurrency(adjFV);
                    document.getElementById('upside').innerHTML = `<span class="${upside > 0 ? 'color-green' : 'color-red'}">${utils.formatPercent(upside)}</span>`;
                    let rec = 'HOLD', recCls = 'color-orange';
                    if (upside > 20) { rec = 'STRONG BUY'; recCls = 'color-green'; }
                    else if (upside > 10) { rec = 'BUY'; recCls = 'color-green'; }
                    else if (upside < -15) { rec = 'STRONG SELL'; recCls = 'color-red'; }
                    else if (upside < -5) { rec = 'SELL'; recCls = 'color-red'; }
                    document.getElementById('recommendation').innerHTML = `<strong class="${recCls}">${rec}</strong>`;
                    document.getElementById('dcfAnalysis').innerHTML = upside > 0
                        ? `Current valuation suggests <strong style="color:var(--green);">${utils.formatPercent(upside)} upside</strong> based on DCF with bubble adjustment of ${adj.toFixed(2)}x.`
                        : `Current price implies <strong style="color:var(--red-soft);">${utils.formatPercent(Math.abs(upside))} downside</strong>. Bubble score of ${bs.toFixed(1)} suggests elevated risk.`;
                },
                showDetail(item) {
                    const panel = document.getElementById('detailPanel');
                    document.getElementById('detailTitle').textContent = item.symbol;
                    panel.classList.add('active');
                    const scoreCls = item.score > 8 ? 'color-red' : item.score > 6 ? 'color-orange' : 'color-green';
                    const chgCls = item.changePercent >= 0 ? 'color-green' : 'color-red';
                    const analysis = item.score > 8
                        ? '<strong style="color:var(--red-soft);">High bubble risk.</strong> Consider reducing exposure.'
                        : item.score > 6
                        ? '<strong style="color:var(--orange);">Moderate bubble signals.</strong> Monitor closely.'
                        : '<strong style="color:var(--green);">Relatively stable.</strong> Suitable for institutional holding.';
                    document.getElementById('detailContent').innerHTML = `
                        <div class="metric-row"><span>Company</span><span class="metric-value">${item.name}</span></div>
                        <div class="metric-row"><span>Sector</span><span class="metric-value color-gold">${item.sector}</span></div>
                        <div class="metric-row"><span>Price</span><span class="metric-value color-gold">${utils.formatCurrency(item.price)}</span></div>
                        <div class="metric-row"><span>Change</span><span class="metric-value ${chgCls}">${utils.formatPercent(item.changePercent)}</span></div>
                        <div class="metric-row"><span>Bubble Score</span><span class="metric-value ${scoreCls}">${utils.formatNumber(item.score,1)} / 10</span></div>
                        <div style="background:rgba(0,0,0,0.25); border-left:2px solid var(--gold); padding:1rem; margin-top:1rem;">
                            <h4 style="color:var(--gold); margin-bottom:0.5rem;">Analysis</h4>
                            <p>${analysis}</p>
                        </div>
                    `;
                }
            };

            // === CHARTS ===
            const charts = {
                async initDashboard() {
                    const ctx = document.getElementById('dashboardChart');
                    if (!ctx) return;
                    const ndx = await api.fetchDailyCloses('NDX', '1mo');
                    const nvda = await api.fetchDailyCloses('NVDA', '1mo');
                    const labels = Array.from({length: Math.min(30, ndx.length)}, (_,i) => i+1);
                    if (state.charts.dashboard) state.charts.dashboard.destroy();
                    state.charts.dashboard = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [
                                {label:'NASDAQ-100', data:ndx.slice(-30), borderColor:'#C5A059', backgroundColor:'rgba(197,160,89,0.04)', tension:0.4, borderWidth:1.5, pointRadius:0, pointHoverRadius:3, yAxisID:'y'},
                                {label:'NVDA', data:nvda.slice(-30), borderColor:'#34D399', backgroundColor:'rgba(52,211,153,0.04)', tension:0.4, borderWidth:1.5, pointRadius:0, pointHoverRadius:3, yAxisID:'y1'}
                            ]
                        },
                        options: {
                            responsive:true, maintainAspectRatio:false,
                            interaction: {mode:'index', intersect:false},
                            plugins: {
                                legend: {labels:{color:'#9FA6B4', font:{size:10, family:'Inter'}}},
                                tooltip: {backgroundColor:'rgba(6,6,9,0.96)', titleColor:'#C5A059', bodyColor:'#9FA6B4', borderColor:'rgba(197,160,89,0.15)', borderWidth:1},
                                zoom: {zoom:{wheel:{enabled:true}, pinch:{enabled:true}, mode:'x'}, pan:{enabled:true, mode:'x'}}
                            },
                            scales: {
                                y: {position:'left', grid:{color:'rgba(197,160,89,0.03)'}, ticks:{color:'#6B7280', font:{size:9, family:'Inter'}}},
                                y1: {position:'right', grid:{drawOnChartArea:false}, ticks:{color:'#6B7280', font:{size:9, family:'Inter'}}},
                                x: {grid:{color:'rgba(197,160,89,0.03)'}, ticks:{color:'#6B7280', font:{size:8, family:'Inter'}}}
                            }
                        }
                    });
                },
                drawHistory() {
                    const canvas = document.getElementById('historyCanvas');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    const rect = canvas.parentElement.getBoundingClientRect();
                    canvas.width = rect.width * 2;
                    canvas.height = 350 * 2;
                    canvas.style.width = rect.width + 'px';
                    canvas.style.height = '350px';
                    ctx.scale(2,2);
                    const w = rect.width, h = 350, pad = {top:30, right:30, bottom:40, left:50};
                    const plotW = w - pad.left - pad.right;
                    const plotH = h - pad.top - pad.bottom;

                    const dotcom = [100,105,108,115,120,128,135,140,150,162,175,185,195,210,225,240,260,280,300,325,350,380,410,445,480,520,560,600,640,680,720,760,800,780,720,660,580,520,470,430,400,370,350,330,310,295,280,270,260,250,240,230,225,220,215,210,205,200,198,195,190,188,185,183,180,178,175,173,170,168,165,163,160,158,155,153,150,148,145,143,140,138,135,133,130];
                    const aiBoom = [100,108,112,118,125,135,145,155,168,180,195,210,225,242,260,278,298,320,340,365,390,410,435,460,485,510,540,565,590,620,650,670,695,720,745,770,790,810,830];
                    const maxY = 850, months = 84;

                    // Grid
                    ctx.strokeStyle = 'rgba(255,255,255,0.03)';
                    ctx.lineWidth = 0.5;
                    for (let i = 0; i <= 4; i++) {
                        const y = pad.top + (plotH/4) * i;
                        ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + plotW, y); ctx.stroke();
                    }

                    // Labels
                    ctx.fillStyle = '#4B5060';
                    ctx.font = '10px Inter';
                    ctx.textAlign = 'right';
                    for (let i = 0; i <= 4; i++) {
                        const val = maxY - (maxY/4)*i;
                        const y = pad.top + (plotH/4)*i;
                        ctx.fillText(Math.round(val), pad.left-8, y+4);
                    }
                    ctx.textAlign = 'center';
                    for (let i = 0; i <= 7; i++) {
                        const month = i*12;
                        const x = pad.left + (month/months)*plotW;
                        ctx.fillText('Y' + (i+1), x, h-pad.bottom+20);
                    }

                    const toX = m => pad.left + (m/months)*plotW;
                    const toY = v => pad.top + plotH - (v/maxY)*plotH;

                    // Dot-com
                    ctx.beginPath();
                    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
                    ctx.lineWidth = 1.5;
                    ctx.setLineDash([4,4]);
                    dotcom.forEach((v,i) => i===0 ? ctx.moveTo(toX(i), toY(v)) : ctx.lineTo(toX(i), toY(v)));
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // AI
                    ctx.beginPath();
                    ctx.strokeStyle = '#C5A059';
                    ctx.lineWidth = 2.5;
                    aiBoom.forEach((v,i) => i===0 ? ctx.moveTo(toX(i), toY(v)) : ctx.lineTo(toX(i), toY(v)));
                    ctx.stroke();

                    // Marker
                    const hereX = toX(38), hereY = toY(aiBoom[38]);
                    ctx.beginPath(); ctx.arc(hereX, hereY, 5, 0, 2*Math.PI); ctx.fillStyle = '#C5A059'; ctx.fill();
                    ctx.beginPath(); ctx.arc(hereX, hereY, 8, 0, 2*Math.PI); ctx.strokeStyle = 'rgba(197,160,89,0.3)'; ctx.lineWidth=1; ctx.stroke();
                    ctx.fillStyle = '#C5A059';
                    ctx.font = '500 9px Inter';
                    ctx.textAlign = 'left';
                    ctx.fillText('← YOU ARE HERE', hereX+14, hereY+4);

                    // Legend
                    ctx.fillStyle = '#6B7280';
                    ctx.font = '10px Inter';
                    ctx.textAlign = 'left';
                    ctx.setLineDash([4,4]);
                    ctx.beginPath(); ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.moveTo(pad.left+10, pad.top+10); ctx.lineTo(pad.left+35, pad.top+10); ctx.stroke();
                    ctx.setLineDash([]);
                    ctx.fillText('Dot-com (1995–2002)', pad.left+40, pad.top+14);
                    ctx.beginPath(); ctx.strokeStyle = '#C5A059'; ctx.lineWidth=2; ctx.moveTo(pad.left+10, pad.top+28); ctx.lineTo(pad.left+35, pad.top+28); ctx.stroke();
                    ctx.fillText('AI Boom (2022–present)', pad.left+40, pad.top+32);
                }
            };

            // === EXPORTERS ===
            const exporters = {
                async toPDF() {
                    utils.showLoading(true, 'Generating PDF...');
                    try {
                        const el = document.getElementById('tab-dashboard');
                        const canvas = await html2canvas(el, {scale:2, backgroundColor:'#060609', logging:false});
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jspdf.jsPDF({orientation:'portrait', unit:'mm', format:'a4'});
                        const w = pdf.internal.pageSize.getWidth();
                        const h = (canvas.height * w) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 0, 0, w, h);
                        pdf.save(`NWA_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                        utils.showToast('PDF exported', 'success');
                    } catch(e) {
                        utils.showToast('PDF export failed', 'error');
                    } finally { utils.showLoading(false); }
                },
                toCSV(data, filename) {
                    if (!data?.length) return;
                    const headers = Object.keys(data[0]);
                    const csv = [headers, ...data.map(obj => headers.map(h => obj[h] || ''))].map(r => r.join(',')).join('\n');
                    const blob = new Blob([csv], {type:'text/csv'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = filename;
                    a.click();
                    utils.showToast('CSV exported', 'success');
                }
            };

            // === HANDLERS ===
            const handlers = {
                refreshTimer: null,
                setupNavigation() {
                    document.querySelectorAll('.nav-tab').forEach(tab => {
                        tab.addEventListener('click', async () => {
                            const target = tab.dataset.tab;
                            document.querySelectorAll('.nav-tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected','false'); });
                            document.querySelectorAll('.toolkit-section').forEach(p => p.classList.remove('active'));
                            tab.classList.add('active');
                            tab.setAttribute('aria-selected','true');
                            document.getElementById('tab-' + target).classList.add('active');

                            // Load data if needed
                            if (target === 'companies' && !state.heatmap.length) await loaders.loadHeatmapData();
                            if (target === 'news' && !state.news.length) await loaders.loadNews();
                            if (target === 'early-warning') await loaders.loadProtocol();
                            if (target === 'dashboard' && !state.charts.dashboard) await charts.initDashboard();
                            if (target === 'history') setTimeout(() => charts.drawHistory(), 200);

                            // Reveal
                            const newReveals = document.querySelectorAll(`#tab-${target} .reveal`);
                            setTimeout(() => {
                                newReveals.forEach((el, i) => setTimeout(() => el.classList.add('visible'), i*80));
                            }, 100);
                        });
                    });
                },
                setupControls() {
                    // Auto-refresh toggle
                    const autoBtn = document.getElementById('autoRefreshToggle');
                    if (autoBtn) {
                        autoBtn.textContent = CONFIG.autoRefresh ? 'ON' : 'OFF';
                        autoBtn.addEventListener('click', () => {
                            CONFIG.autoRefresh = !CONFIG.autoRefresh;
                            localStorage.setItem('autoRefresh', CONFIG.autoRefresh);
                            autoBtn.textContent = CONFIG.autoRefresh ? 'ON' : 'OFF';
                            if (CONFIG.autoRefresh) this.startAutoRefresh();
                            else this.stopAutoRefresh();
                            utils.showToast(`Auto-refresh ${CONFIG.autoRefresh ? 'enabled' : 'disabled'}`);
                        });
                    }

                    // Settings
                    document.getElementById('settingsLink').addEventListener('click', (e) => {
                        e.preventDefault();
                        document.getElementById('settingsModal').classList.add('active');
                        document.getElementById('fmpKey').value = CONFIG.apiKeys.fmp;
                        document.getElementById('alphaKey').value = CONFIG.apiKeys.alpha;
                        document.getElementById('refreshInterval').value = CONFIG.refreshInterval / 60000;
                    });

                    document.getElementById('saveSettingsBtn').addEventListener('click', () => {
                        CONFIG.apiKeys.fmp = document.getElementById('fmpKey').value;
                        CONFIG.apiKeys.alpha = document.getElementById('alphaKey').value;
                        CONFIG.refreshInterval = parseInt(document.getElementById('refreshInterval').value) * 60000;
                        localStorage.setItem('fmp_key', CONFIG.apiKeys.fmp);
                        localStorage.setItem('alpha_key', CONFIG.apiKeys.alpha);
                        localStorage.setItem('refreshInterval', CONFIG.refreshInterval / 60000);
                        document.getElementById('settingsModal').classList.remove('active');
                        utils.showToast('Settings saved', 'success');
                        if (CONFIG.autoRefresh) { this.stopAutoRefresh(); this.startAutoRefresh(); }
                    });

                    document.getElementById('cancelSettingsBtn').addEventListener('click', () => {
                        document.getElementById('settingsModal').classList.remove('active');
                    });

                    // Manual flags
                    ['flagASML','flagTaiwan','flagMSFT','flagNVDA'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            const flag = id.replace('flag','').toLowerCase();
                            if (CONFIG.manualFlags[flag]) el.classList.add('active');
                            el.addEventListener('click', () => {
                                CONFIG.manualFlags[flag] = !CONFIG.manualFlags[flag];
                                localStorage.setItem('flag_' + flag, CONFIG.manualFlags[flag]);
                                el.classList.toggle('active', CONFIG.manualFlags[flag]);
                                utils.showToast(`${id.replace('flag','')} flag ${CONFIG.manualFlags[flag] ? 'activated' : 'deactivated'}`);
                            });
                        }
                    });

                    // DCF sliders
                    ['waccSlider','growthSlider','terminalSlider','fcfSlider'].forEach(id => {
                        document.getElementById(id)?.addEventListener('input', utils.debounce(() => ui.updateDCF(), 150));
                    });

                    document.getElementById('resetDCFBtn')?.addEventListener('click', () => {
                        document.getElementById('waccSlider').value = 8.5;
                        document.getElementById('growthSlider').value = 25;
                        document.getElementById('terminalSlider').value = 2.5;
                        document.getElementById('fcfSlider').value = 25;
                        ui.updateDCF();
                    });

                    // Reset zoom
                    document.getElementById('resetZoomBtn')?.addEventListener('click', () => {
                        if (state.charts.dashboard) state.charts.dashboard.resetZoom();
                    });

                    // Refresh news
                    document.getElementById('refreshNewsBtn')?.addEventListener('click', () => loaders.loadNews());

                    // Search
                    document.getElementById('companySearch')?.addEventListener('input', utils.debounce((e) => {
                        const filter = e.target.value.toUpperCase();
                        document.querySelectorAll('#companiesGrid .company-card').forEach(card => {
                            card.style.display = card.textContent.toUpperCase().includes(filter) ? '' : 'none';
                        });
                    }, 250));

                    // Filters
                    document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.filter-btn[data-filter]').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            const filter = btn.dataset.filter;
                            document.querySelectorAll('#companiesGrid .company-card').forEach(card => {
                                const tier = card.querySelector('.cc-tier')?.textContent || '';
                                const score = parseInt(card.querySelector('.cc-bubble-score')?.textContent || '0');
                                let show = true;
                                if (filter === 'tier-1') show = tier.includes('Tier 1');
                                else if (filter === 'tier-2') show = tier.includes('Tier 2');
                                else if (filter === 'tier-3') show = tier.includes('Tier 3');
                                else if (filter === 'high-risk') show = score >= 70;
                                card.style.display = show ? '' : 'none';
                            });
                        });
                    });

                    // Contagion slider
                    const slider = document.getElementById('contagionSlider');
                    if (slider) {
                        slider.addEventListener('input', (e) => {
                            const val = e.target.value;
                            document.getElementById('contagionValue').textContent = `-${val}%`;
                            // Update tiers (simplified)
                        });
                    }

                    // Stress test
                    document.getElementById('runStressTest')?.addEventListener('click', () => {
                        const inputs = document.querySelectorAll('.portfolio-input');
                        let total = 0, aiExposure = 0;
                        inputs.forEach(i => {
                            const w = parseFloat(i.value) || 0;
                            const b = parseFloat(i.dataset.aiBeta) || 0;
                            total += w;
                            aiExposure += w * b;
                        });
                        if (total === 0) { alert('Enter at least one position'); return; }
                        const exposure = aiExposure / 100;
                        document.getElementById('stressResults').classList.add('visible');
                        document.getElementById('exposureValue').textContent = aiExposure.toFixed(1) + '%';
                        const signal = document.getElementById('exposureSignal');
                        if (aiExposure > 50) { signal.textContent = 'Critical'; signal.className = 'bic-signal signal-high'; }
                        else if (aiExposure > 30) { signal.textContent = 'Elevated'; signal.className = 'bic-signal signal-elevated'; }
                        else { signal.textContent = 'Moderate'; signal.className = 'bic-signal signal-low'; }
                        document.getElementById('scenarioSoft').textContent = '-' + (exposure * 20).toFixed(1) + '%';
                        document.getElementById('scenarioHard').textContent = '-' + (exposure * 40).toFixed(1) + '%';
                        document.getElementById('scenarioDotcom').textContent = '-' + (exposure * 70).toFixed(1) + '%';
                    });

                    // Close detail panel
                    document.getElementById('closeDetailBtn')?.addEventListener('click', () => {
                        document.getElementById('detailPanel').classList.remove('active');
                    });

                    // Export
                    document.getElementById('exportDashCSV')?.addEventListener('click', () => {
                        const data = Object.entries(state.market).map(([k,v]) => ({Index:k.toUpperCase(), Price:v?.price, Change:v?.change, 'Change %':v?.changePercent}));
                        exporters.toCSV(data, 'nwa_dashboard.csv');
                    });
                    document.getElementById('exportDashPDF')?.addEventListener('click', exporters.toPDF);
                    document.getElementById('exportDCF')?.addEventListener('click', () => {
                        exporters.toCSV([{
                            Symbol:'NVDA',
                            'Current Price':document.getElementById('dcfPrice').textContent,
                            'Fair Value':document.getElementById('fairValue').textContent,
                            'Adj Fair Value':document.getElementById('adjFairValue').textContent,
                            Upside:document.getElementById('upside').textContent,
                            Recommendation:document.getElementById('recommendation').textContent
                        }], 'nwa_dcf.csv');
                    });

                    // Escape key
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            document.getElementById('detailPanel').classList.remove('active');
                            document.getElementById('settingsModal').classList.remove('active');
                        }
                    });
                },
                startAutoRefresh() {
                    if (this.refreshTimer) clearInterval(this.refreshTimer);
                    this.refreshTimer = setInterval(async () => {
                        await loaders.loadMarketData();
                        await loaders.loadStockData();
                        await loaders.loadProtocol();
                        utils.showToast('Data refreshed', 'success');
                    }, CONFIG.refreshInterval);
                },
                stopAutoRefresh() {
                    if (this.refreshTimer) { clearInterval(this.refreshTimer); this.refreshTimer = null; }
                }
            };

            // === REVEAL ===
            const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (!prefersReduced && 'IntersectionObserver' in window) {
                const io = new IntersectionObserver((entries) => {
                    entries.forEach(e => {
                        if (e.isIntersecting) { e.target.classList.add('visible'); io.unobserve(e.target); }
                    });
                }, { threshold: 0.05 });
                document.querySelectorAll('.reveal').forEach(el => io.observe(el));
            } else {
                document.querySelectorAll('.reveal').forEach(el => el.classList.add('visible'));
            }

            // === YEAR ===
            document.getElementById('year').textContent = new Date().getFullYear();

            // === INIT ===
            async function init() {
                handlers.setupNavigation();
                handlers.setupControls();
                await loaders.loadAll();
                await charts.initDashboard();
                if (CONFIG.autoRefresh) handlers.startAutoRefresh();

                // Initialize Early Warning with static data (could be dynamic)
                document.getElementById('ewGrid').innerHTML = `
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">Insider Selling Pace</span><span class="ew-status ew-status-high">High</span></div><p class="ew-card-detail">AI sector insider sales reached $2.4B in trailing 90 days — 3.2x the 5-year average.</p><div class="ew-card-trend trend-up">↑ Accelerating</div></div>
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">Retail Call Buying</span><span class="ew-status ew-status-high">High</span></div><p class="ew-card-detail">Call/put ratio on AI names at 3.8x — 89th percentile since 2020.</p><div class="ew-card-trend trend-up">↑ Rising</div></div>
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">Hyperscaler Capex ROI</span><span class="ew-status ew-status-watch">Watch</span></div><p class="ew-card-detail">Combined capex of MSFT+GOOG+AMZN+META at $240B/yr. AI revenue attribution still unclear.</p><div class="ew-card-trend trend-flat">→ Stable</div></div>
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">AI Revenue Quality</span><span class="ew-status ew-status-ok">OK</span></div><p class="ew-card-detail">Recurring revenue ratio at 72% for AI infrastructure companies.</p><div class="ew-card-trend trend-flat">→ Stable</div></div>
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">Analyst Herd Behavior</span><span class="ew-status ew-status-high">High</span></div><p class="ew-card-detail">92% of NVDA ratings are Buy/Outperform. Target dispersion at 10-year low.</p><div class="ew-card-trend trend-up">↑ Increasing</div></div>
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">Credit Spreads</span><span class="ew-status ew-status-ok">OK</span></div><p class="ew-card-detail">IG and HY spreads remain tight. No systemic stress in credit markets.</p><div class="ew-card-trend trend-flat">→ Stable</div></div>
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">AI IPO Pipeline</span><span class="ew-status ew-status-watch">Watch</span></div><p class="ew-card-detail">14 AI-related IPOs filed in Q2 2025. Accelerating from 6 in Q1.</p><div class="ew-card-trend trend-up">↑ Rising</div></div>
                    <div class="ew-card"><div class="ew-card-header"><span class="ew-card-name">Semiconductor Inventory</span><span class="ew-status ew-status-watch">Watch</span></div><p class="ew-card-detail">GPU channel inventory building at distributors. Lead times normalizing.</p><div class="ew-card-trend trend-up">↑ Building</div></div>
                `;
                document.getElementById('ewAlerts').innerHTML += `
                    <div class="ew-alert-item"><div class="alert-severity severity-critical"></div><div class="alert-content"><div class="alert-title">SMCI Insider Sale — $45M</div><div class="alert-desc">Largest insider sale since IPO.</div></div><div class="alert-date">Jul 12</div></div>
                    <div class="ew-alert-item"><div class="alert-severity severity-warning"></div><div class="alert-content"><div class="alert-title">MSFT Capex Guidance Raised to $80B</div><div class="alert-desc">AI infrastructure spend acceleration.</div></div><div class="alert-date">Jul 10</div></div>
                `;
                document.getElementById('contagionTiers').innerHTML = `
                    <div class="contagion-tier"><div class="ct-header"><span class="ct-title">Tier 1 — Direct</span><span class="ct-impact color-red" id="tier1Impact">-28% avg</span></div><div class="ct-company"><span class="ct-ticker">AVGO</span><div class="ct-bar"><div class="ct-bar-fill" style="width:70%"></div></div><span class="ct-change color-red">-28%</span></div><div class="ct-company"><span class="ct-ticker">AMD</span><div class="ct-bar"><div class="ct-bar-fill" style="width:80%"></div></div><span class="ct-change color-red">-32%</span></div><div class="ct-company"><span class="ct-ticker">SMCI</span><div class="ct-bar"><div class="ct-bar-fill" style="width:100%"></div></div><span class="ct-change color-red">-52%</span></div><div class="ct-company"><span class="ct-ticker">MRVL</span><div class="ct-bar"><div class="ct-bar-fill" style="width:62%"></div></div><span class="ct-change color-red">-25%</span></div><div class="ct-company"><span class="ct-ticker">ARM</span><div class="ct-bar"><div class="ct-bar-fill" style="width:87%"></div></div><span class="ct-change color-red">-35%</span></div></div>
                    <div class="contagion-tier"><div class="ct-header"><span class="ct-title">Tier 2 — Indirect</span><span class="ct-impact color-orange" id="tier2Impact">-14% avg</span></div><div class="ct-company"><span class="ct-ticker">MSFT</span><div class="ct-bar"><div class="ct-bar-fill" style="width:30%"></div></div><span class="ct-change color-orange">-12%</span></div><div class="ct-company"><span class="ct-ticker">GOOG</span><div class="ct-bar"><div class="ct-bar-fill" style="width:35%"></div></div><span class="ct-change color-orange">-14%</span></div><div class="ct-company"><span class="ct-ticker">AMZN</span><div class="ct-bar"><div class="ct-bar-fill" style="width:27%"></div></div><span class="ct-change color-orange">-11%</span></div><div class="ct-company"><span class="ct-ticker">TSM</span><div class="ct-bar"><div class="ct-bar-fill" style="width:45%"></div></div><span class="ct-change color-orange">-18%</span></div></div>
                    <div class="contagion-tier"><div class="ct-header"><span class="ct-title">Tier 3 — Peripheral</span><span class="ct-impact color-orange" id="tier3Impact">-10% avg</span></div><div class="ct-company"><span class="ct-ticker">EQIX</span><div class="ct-bar"><div class="ct-bar-fill" style="width:20%"></div></div><span class="ct-change color-orange">-8%</span></div><div class="ct-company"><span class="ct-ticker">VST</span><div class="ct-bar"><div class="ct-bar-fill" style="width:55%"></div></div><span class="ct-change color-red">-22%</span></div><div class="ct-company"><span class="ct-ticker">CEG</span><div class="ct-bar"><div class="ct-bar-fill" style="width:47%"></div></div><span class="ct-change color-orange">-19%</span></div></div>
                `;
                document.getElementById('methodologyGrid').innerHTML = Array(12).fill().map((_,i) => `
                    <div class="method-card">
                        <div class="method-number">${String(i+1).padStart(2,'0')}</div>
                        <div class="method-title">Factor ${i+1}</div>
                        <div class="method-desc">Quantitative factor with predictive power for bubble detection.</div>
                        <div class="method-weight">Weight: ${(8 + (i%5)).toFixed(0)}%</div>
                    </div>
                `).join('');

                utils.showToast('Toolkit loaded', 'success');
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
